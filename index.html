<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TONFiles Market — Demo</title>
<style>
/* === Базовые === */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:#000;
  color:#fff;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
}

/* brand color */
:root{--ton-green:#36ff12;--panel:#0b0b0b;--muted:#9fbf9f;--card-border:#1a1a1a;}

header{
  position:sticky;top:0;z-index:110;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;background:var(--panel);border-bottom:2px solid var(--ton-green);
  box-shadow:0 0 10px rgba(54,255,18,0.04)
}
header img.logo{height:30px;display:block}
header .balance{display:flex;gap:8px;align-items:center;font-weight:700}
.ton-icon{height:1em;width:auto;vertical-align:middle;display:inline-block}

/* main layout */
main{max-width:1200px;margin:0 auto;padding:16px 14px 110px}

/* tabs bottom */
.tabs{
  position:fixed;left:0;right:0;bottom:0;z-index:200;
  display:flex;background:var(--panel);border-top:2px solid var(--ton-green);
}
.tabs button{
  flex:1;padding:12px;border:0;background:none;color:#aaa;font-weight:700;cursor:pointer;
}
.tabs button.active{color:var(--ton-green)}

/* sections */
.section{display:none}
.section.active{display:block}

/* search/filter block */
.search-filter{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input, input[type="text"], input[type="number"], select, textarea, button.file-btn {
  background:var(--panel);
  border:1px solid var(--ton-green);
  color:#fff;padding:8px;border-radius:8px;
  font-size:14px;
}
.input{flex:1;min-width:140px;padding:8px;border-radius:8px}
#search{padding:10px;border-radius:10px;border:1px solid var(--ton-green);background:var(--panel);color:#fff;width:100%}
.small{font-size:13px;color:var(--muted)}

/* grid */
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));align-items:start}

/* card */
.card{
  background:var(--panel);border:1px solid var(--card-border);border-radius:14px;overflow:hidden;
  display:flex;flex-direction:column;cursor:pointer;transition:transform .16s,box-shadow .16s,border-color .16s;
  height:320px;
}
.card:hover{transform:translateY(-3px);border-color:var(--ton-green);box-shadow:0 0 15px rgba(54,255,18,0.08)}
.image-wrap{height:160px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden}
.image-wrap img{width:100%;height:100%;object-fit:cover;display:block}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px;position:relative;flex:1;justify-content:space-between}
.item-id{position:absolute;right:10px;top:8px;font-size:12px;color:#666}
.title{font-size:15px;font-weight:700;margin:0}
.desc{font-size:13px;color:#bfc7d9;margin:0;line-height:1.2;max-height:2.4em;overflow:hidden}
.row-info{display:flex;justify-content:space-between;align-items:center;color:#cfd8d0;font-size:13px}
.row-info .price{display:inline-flex;align-items:center;gap:6px}
.btn-row{display:flex;gap:8px;margin-top:8px}
.btn{flex:1;padding:8px;border-radius:8px;border:0;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap}
.btn-primary{background:var(--ton-green);color:#000}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe}
.btn-danger{background:transparent;border:1px solid #ff5c5c;color:#ff9b9b}

/* modal */
.modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.75);z-index:400}
.modal.show{display:flex}
.modal-card{background:var(--panel);border:1px solid var(--ton-green);border-radius:12px;padding:16px;width:95%;max-width:520px;box-shadow:0 12px 40px rgba(54,255,18,0.06);position:relative}
.modal-card img{width:100%;max-height:260px;object-fit:cover;border-radius:8px;margin-bottom:12px}
.modal-title{font-size:18px;margin:0 0 6px}
.modal-desc{color:#bfc7d9;margin:0 0 10px}
.modal-line{display:flex;justify-content:center;gap:10px;align-items:center;color:#dfe6f9;margin-bottom:10px;font-weight:700}
.modal-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.close-btn{position:absolute;top:10px;right:12px;font-size:20px;color:var(--ton-green);background:none;border:none;cursor:pointer}

/* stars */
.stars{font-size:22px;margin:8px 0;display:flex;gap:6px;justify-content:center}
.star{cursor:pointer;color:#555}
.star.on{color:var(--ton-green)}

/* publish */
#publish form{max-width:720px;margin:0 auto;display:flex;flex-direction:column;gap:10px}
label{color:var(--ton-green);font-weight:700;font-size:13px}

/* profile slide (seller) */
.profile-slide{
  position:fixed;left:0;right:0;bottom:-100%;background:var(--panel);border-top:2px solid var(--ton-green);
  border-radius:12px 12px 0 0;box-shadow:0 -8px 30px rgba(54,255,18,0.06);padding:12px 14px;z-index:450;
  transition:bottom .36s cubic-bezier(.2,.9,.2,1);
  max-height:92vh;overflow:auto;
}
.profile-slide.show{bottom:0}

/* handle to close slide */
.slide-handle{width:56px;height:6px;background:rgba(255,255,255,0.08);border-radius:6px;margin:6px auto 12px;cursor:pointer}

/* profile header */
.profile-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.profile-header img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--ton-green)}
.profile-info{display:flex;flex-direction:column;gap:4px}
.profile-name{font-size:18px;font-weight:700}
.profile-meta{color:#aaa;font-size:14px}

/* profile edit modal */
#profile-edit{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;justify-content:center;align-items:center;z-index:500}
#profile-edit.show{display:flex}
.profile-edit-card{background:var(--panel);border:1px solid var(--ton-green);border-radius:12px;padding:16px;width:95%;max-width:420px}

/* toast */
.toast{position:fixed;right:18px;bottom:84px;background:var(--ton-green);color:#000;border-radius:8px;padding:10px 14px;opacity:0;transition:opacity .25s;z-index:1000}
.toast.show{opacity:1}

/* small helpers */
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>

<header>
  <img class="logo" src="tonfiles.svg" alt="TONFiles">
  <div class="balance"><span id="balance">1000.00</span> <img class="ton-icon" id="balance-ton" src="ton1.svg" alt="TON"></div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="section active">
    <div class="search-filter">
      <input id="search" placeholder="Поиск по названию или описанию..." />
      <div class="row">
        <input id="min-price" type="number" placeholder="Мин. цена" step="0.01" class="input" />
        <input id="max-price" type="number" placeholder="Макс. цена" step="0.01" class="input" />
        <input id="id-search" type="number" placeholder="ID товара" class="input" />
      </div>
      <div class="row">
        <select id="sort-select" class="input" style="min-width:180px">
          <option value="latest">Последние</option>
          <option value="price-asc">Цена: по возрастанию</option>
          <option value="price-desc">Цена: по убыванию</option>
          <option value="best">Отзывы: лучшие</option>
        </select>
        <button class="btn btn-primary" id="apply-btn">Применить</button>
      </div>
    </div>

    <div class="grid" id="market-grid"></div>
    <p id="market-empty" class="small center hidden" style="margin-top:10px">Не найдено</p>
  </section>

  <!-- PUBLISH -->
  <section id="publish" class="section" style="display:none">
    <form id="publish-form">
      <label for="pub-title">Название</label>
      <input id="pub-title" placeholder="Название" />
      <label for="pub-desc">Описание</label>
      <textarea id="pub-desc" rows="4"></textarea>
      <label for="pub-price">Цена (TON)</label>
      <input id="pub-price" type="number" step="0.01" />
      <small id="commission-info" class="small">Вы получите: 0.00 TON (с учётом комиссии 10%)</small>
      <label for="pub-img">Превью (изображение)</label>
      <input id="pub-img" type="file" accept="image/*" />
      <label for="pub-file">Файл для продажи</label>
      <input id="pub-file" type="file" />
      <button class="btn btn-primary" type="submit">Опубликовать</button>
    </form>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="section" style="display:none">
    <div id="profile-view"></div>
  </section>
</main>

<!-- bottom tabs -->
<div class="tabs">
  <button class="active" onclick="switchTab('home', this)">Главная</button>
  <button onclick="switchTab('publish', this)">Публикация</button>
  <button onclick="switchTab('profile', this)">Профиль</button>
</div>

<!-- item modal -->
<div id="modal" class="modal"><div class="modal-card" id="modal-card"></div></div>

<!-- seller slide -->
<div id="profile-slide" class="profile-slide" aria-hidden="true">
  <div class="slide-handle" id="slide-handle" title="Закрыть"></div>
  <div id="profile-slide-content"></div>
</div>

<!-- profile edit modal -->
<div id="profile-edit"><div class="profile-edit-card" id="profile-edit-card"></div></div>

<!-- toast -->
<div id="toast" class="toast"></div>

<script>
/* ===========================
   Demo data & state
   =========================== */
const MIN_PRICE = 0.1;
let balance = 1000.00;
let refBalance = 0.00;
let currentUserId = 1; // demo user id
// users: simple store
let users = {
  1: { id:1, username:"@tonuser", name:"TON User", avatar:"https://via.placeholder.com/100", joined:"01.09.2024", trades:400, visibility:{username:true,joined:true,trades:true,rating:true} },
  // example seller
  2: { id:2, username:"@wallet_dev", name:"WalletDev", avatar:"https://via.placeholder.com/100", joined:"02.02.2024", trades:500, visibility:{username:true,joined:true,trades:true,rating:true} }
};

// items structure:
// {id, name, desc, price, img, file, ownerId, reviews: [{userId, value}], created}
let items = [
  { id:101, name:"Скрипт Telegram Bot", desc:"Полностью рабочий бот", price:15, img:"https://via.placeholder.com/600x400?text=Bot", file:"bot.zip", ownerId:2, reviews:[{userId:2,value:5},{userId:3,value:4}], created:Date.now()-500000 },
  { id:102, name:"Видеоурок по дизайну", desc:"Советы для UI/UX", price:8, img:"https://via.placeholder.com/600x400?text=Design", file:"design.mp4", ownerId:3, reviews:[{userId:4,value:5},{userId:5,value:5},{userId:2,value:4}], created:Date.now()-400000 },
  { id:103, name:"NFT шаблон", desc:"Шаблон NFT-коллекции", price:22, img:"https://via.placeholder.com/600x400?text=NFT", file:"nft.psd", ownerId:4, reviews:[{userId:4,value:4},{userId:2,value:3}], created:Date.now()-300000 },
  { id:104, name:"React сайт", desc:"Красивый адаптивный шаблон", price:18, img:"https://via.placeholder.com/600x400?text=React", file:"site.zip", ownerId:5, reviews:[], created:Date.now()-200000 },
];
// add a demo item owned by current user
items.unshift({ id:100001, name:"Мой тестовый гайд", desc:"Тестовый файл от меня", price:5.5, img:"https://via.placeholder.com/600x400?text=My+Guide", file:"guide.pdf", ownerId:currentUserId, reviews:[{userId:currentUserId,value:5}], created:Date.now()-100000 });

// purchases: list of item ids the current user bought
let purchases = [100001]; // demo: user bought own? we won't treat self buy, but keep array usable
// For demo give current user a purchase of item 101:
purchases.push(101);

// helper to track user-specific ratings quickly (not necessary but convenient)
function getUserRating(item, userId){ const r = (item.reviews||[]).find(rr=>rr.userId===userId); return r? r.value : null; }

/* ===========================
   Helpers
   =========================== */
function toMoney(n){ return Number(n).toFixed(2); }
function showToast(msg, time=2200){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), time);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function avgAndCount(revs){
  if(!revs || revs.length===0) return {avg:0,count:0};
  const sum = revs.reduce((a,b)=>a+b.value,0);
  return {avg: sum/revs.length, count: revs.length};
}
function padId(n){ return '#'+String(n).padStart(5,'0'); }

/* ===========================
   Rendering market/cards
   =========================== */
const marketGrid = document.getElementById('market-grid');
const marketEmpty = document.getElementById('market-empty');

function renderMarket(){
  document.getElementById('balance').textContent = toMoney(balance);
  // filters
  const q = (document.getElementById('search').value||'').toLowerCase().trim();
  const min = parseFloat(document.getElementById('min-price').value) || 0;
  const max = parseFloat(document.getElementById('max-price').value) || Infinity;
  const idV = parseInt(document.getElementById('id-search').value) || null;
  const sort = document.getElementById('sort-select').value;

  let list = items.slice(); // copy
  list = list.filter(it=>{
    if(idV && it.id !== idV) return false;
    if(!( (it.name+ ' ' + it.desc).toLowerCase().includes(q) )) return false;
    if(it.price < min || it.price > max) return false;
    return true;
  });

  if(sort==='price-asc') list.sort((a,b)=>a.price-b.price);
  else if(sort==='price-desc') list.sort((a,b)=>b.price-a.price);
  else if(sort==='best') list.sort((a,b)=> (avgAndCount(b.reviews).avg - avgAndCount(a.reviews).avg));
  else list.sort((a,b)=> b.created - a.created);

  marketGrid.innerHTML = '';
  if(list.length===0){ marketEmpty.classList.remove('hidden'); } else { marketEmpty.classList.add('hidden'); }

  list.forEach(it=>{
    const owned = (it.ownerId === currentUserId);
    const bought = purchases.includes(it.id);
    const ac = avgAndCount(it.reviews);
    const avg = ac.count ? (Math.round(ac.avg*10)/10).toFixed(1) : '—';
    const idLabel = padId(it.id);
    // card element
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="image-wrap"><img src="${escapeHtml(it.img)}" alt="${escapeHtml(it.name)}"></div>
      <div class="card-body">
        <div class="item-id">${idLabel}</div>
        <div>
          <div class="title">${escapeHtml(it.name)}</div>
          <div class="desc">${escapeHtml(it.desc)}</div>
        </div>
        <div>
          <div class="row-info"><div class="rating">★ ${avg} (${ac.count})</div><div class="price">${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></div></div>
          <div class="btn-row">
            ${owned ? `<button class="btn btn-primary btn-open" data-id="${it.id}">Мой товар</button><button class="btn btn-danger btn-del" data-id="${it.id}">Удалить</button>` :
             bought ? `<button class="btn btn-primary btn-open" data-id="${it.id}">Приобретено</button><button class="btn btn-ghost btn-file" data-id="${it.id}">Получить файл</button>` :
             `<button class="btn btn-primary btn-open" data-id="${it.id}">Купить • ${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></button>` }
          </div>
        </div>
      </div>
    `;
    // click open modal by clicking card (but not when clicking button)
    div.addEventListener('click', (e)=>{
      // if clicked a control button, don't double open (buttons have their own handlers)
      if(e.target.closest('button')) return;
      openItemModal(it.id);
    });
    // attach button handlers
    setTimeout(()=>{ // small timeout to ensure DOM appended if needed
      const btns = div.querySelectorAll('.btn-open');
      btns.forEach(b=> b.addEventListener('click', (ev)=>{ ev.stopPropagation(); openItemModal(parseInt(b.dataset.id)); }));
      const dels = div.querySelectorAll('.btn-del');
      dels.forEach(b=> b.addEventListener('click', ev=>{ ev.stopPropagation(); deleteItem(parseInt(b.dataset.id)); }));
      const files = div.querySelectorAll('.btn-file');
      files.forEach(b=> b.addEventListener('click', ev=>{ ev.stopPropagation(); getFile(parseInt(b.dataset.id)); }));
    },0);

    marketGrid.appendChild(div);
  });
}

/* ===========================
   Modal: item view / buy / rating
   =========================== */
const modal = document.getElementById('modal');
const modalCard = document.getElementById('modal-card');

function openItemModal(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  const owned = it.ownerId === currentUserId;
  const bought = purchases.includes(it.id);
  const ac = avgAndCount(it.reviews);
  const avg = ac.count ? (Math.round(ac.avg*10)/10).toFixed(1) : '—';
  const idLabel = padId(it.id);
  // Build actions
  let actionsHtml = '';
  if(owned){
    actionsHtml = `<button class="btn btn-primary" disabled>Мой товар</button>
                   <button class="btn btn-danger" id="modal-delete" data-id="${it.id}">Удалить</button>`;
  } else if(bought){
    actionsHtml = `<button class="btn btn-primary" disabled>Приобретено</button>
                   <button class="btn btn-ghost" id="modal-file" data-id="${it.id}">Получить файл</button>`;
  } else {
    actionsHtml = `<button class="btn btn-primary" id="modal-buy" data-id="${it.id}">Купить за ${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></button>
                   <button class="btn btn-ghost" id="modal-seller" data-owner="${it.ownerId}">Продавец</button>`;
  }

  // rating stars block - only allow rating if user has purchased and is not owner
  const userRated = getUserRating(it, currentUserId);
  let starsHtml = '';
  if(bought && !owned){
    // show stars: if already rated, fill accordingly and allow change to lower rating (per request)
    const current = userRated || 0;
    for(let s=1;s<=5;s++){
      starsHtml += `<span class="star ${s<=current ? 'on':''}" data-s="${s}" data-id="${it.id}">★</span>`;
    }
    starsHtml = `<div class="stars user-stars" data-id="${it.id}">${starsHtml}</div>`;
  } else if(bought && owned === false && userRated===null){
    // if not rated yet but bought, still show empty stars to allow rating
    for(let s=1;s<=5;s++) starsHtml += `<span class="star" data-s="${s}" data-id="${it.id}">★</span>`;
    starsHtml = `<div class="stars user-stars" data-id="${it.id}">${starsHtml}</div>`;
  } else {
    // no rating UI
    starsHtml = '';
  }

  modalCard.innerHTML = `
    <button class="close-btn" id="modal-close">×</button>
    <img src="${escapeHtml(it.img)}" alt="${escapeHtml(it.name)}">
    <h3 class="modal-title">${escapeHtml(it.name)}</h3>
    <div class="modal-line">★ ${avg} (${ac.count}) &nbsp; • &nbsp; <strong>${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></strong></div>
    <p class="modal-desc">${escapeHtml(it.desc)}</p>
    <div class="modal-actions">${actionsHtml}</div>
    <div id="modal-rating-area">${starsHtml}</div>
  `;
  modal.classList.add('show');

  // wire modal buttons
  const btnClose = document.getElementById('modal-close');
  btnClose && btnClose.addEventListener('click', ()=> modal.classList.remove('show'));

  const btnDel = document.getElementById('modal-delete');
  if(btnDel) btnDel.addEventListener('click', ()=>{ deleteItem(it.id); modal.classList.remove('show'); });

  const btnFile = document.getElementById('modal-file');
  if(btnFile) btnFile.addEventListener('click', ()=>{ getFile(it.id); });

  const btnBuy = document.getElementById('modal-buy');
  if(btnBuy) btnBuy.addEventListener('click', ()=>{ buyItem(it.id); });

  const btnSeller = document.getElementById('modal-seller');
  if(btnSeller) btnSeller.addEventListener('click', ()=>{ openSellerSlide(it.ownerId); modal.classList.remove('show'); });

  // stars rating handlers (allow rate only once, but allow change to lower rating)
  const starsParent = modalCard.querySelector('.user-stars');
  if(starsParent){
    starsParent.addEventListener('click', (e)=>{
      if(!e.target.classList.contains('star')) return;
      const s = parseInt(e.target.dataset.s);
      handleRate(it.id, s);
    });
  }
}

/* Close modal clicking outside */
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

/* ===========================
   Buy / file / delete / rating handling
   =========================== */
function buyItem(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  if(it.ownerId === currentUserId){ showToast('Нельзя купить свой товар'); return; }
  if(balance < it.price){ showToast('Недостаточно средств'); return; }
  // deduct
  balance = Number((balance - it.price).toFixed(2));
  refBalance = Number((refBalance + it.price*0.02).toFixed(2));
  purchases.push(it.id);
  showToast('Покупка успешна');
  // after purchase we want modal to update to show purchased UI
  openItemModal(id);
  renderMarket();
}

function getFile(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  if(!purchases.includes(id)){ showToast('Файл доступен только после покупки'); return; }
  // placeholder behavior
  showToast(`Файл "${it.file}" будет доступен после интеграции бекенда`);
}

function deleteItem(id){
  // confirm
  if(!confirm('Удалить товар? Все отзывы будут утеряны и действие необратимо.')) return;
  // remove
  items = items.filter(x=>x.id!==id);
  // remove from purchases
  purchases = purchases.filter(pid=>pid!==id);
  showToast('Товар удалён');
  // close modals if opened for that item
  modal.classList.remove('show');
  renderMarket();
}

/* rating logic: only one review per user per item, only after purchase, rating saved as integer 1-5 */
function handleRate(itemId, value){
  const it = items.find(x=>x.id===itemId);
  if(!it) return;
  if(!purchases.includes(itemId)){ showToast('Оценивать можно только после покупки'); return; }
  if(it.ownerId === currentUserId){ showToast('Нельзя оценивать свой товар'); return; }
  // find existing
  const existing = (it.reviews||[]).find(r=>r.userId===currentUserId);
  if(existing){
    // allow changing rating only to a lower number? requirement: "можно будет изменить, нажав на меньшее кол-во звезд."
    // we'll allow change to any value, but if we must restrict to lower only, change logic here.
    existing.value = value;
  } else {
    it.reviews = it.reviews || [];
    it.reviews.push({ userId: currentUserId, value });
  }
  showToast('Спасибо за отзыв!');
  openItemModal(itemId); // refresh modal to show updated stars
  renderMarket();
}

/* ===========================
   Publish flow
   =========================== */
const publishForm = document.getElementById('publish-form');
const commissionInfo = document.getElementById('commission-info');
const pubPriceField = document.getElementById('pub-price');

function updateCommission(){
  const v = parseFloat(pubPriceField.value) || 0;
  if(v < MIN_PRICE){
    pubPriceField.style.borderColor = '#ff4b4b';
    commissionInfo.style.color = '#ff4b4b';
    commissionInfo.innerHTML = `Минимальная сумма: ${MIN_PRICE.toFixed(2)} <img class="ton-icon" src="ton1.svg" alt="TON">`;
  } else {
    pubPriceField.style.borderColor = 'var(--ton-green)';
    commissionInfo.style.color = '#9fbf9f';
    commissionInfo.textContent = `Вы получите: ${(v*0.9).toFixed(2)} TON (с учётом комиссии 10%)`;
  }
}

pubPriceField.addEventListener('input', updateCommission);

publishForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const title = document.getElementById('pub-title').value.trim();
  const desc  = document.getElementById('pub-desc').value.trim();
  const price = parseFloat(document.getElementById('pub-price').value);
  const preview = document.getElementById('pub-img').files[0];
  const file = document.getElementById('pub-file').files[0];
  if(!title || !desc || !price || !preview || !file){ showToast('Заполните все поля'); return; }
  if(price < MIN_PRICE){ showToast(`Минимальная цена ${MIN_PRICE.toFixed(2)} TON`); return; }
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const newId = Math.floor(Math.random()*900000)+100000;
    const newItem = {
      id: newId,
      name: title,
      desc: desc,
      price: Number(price.toFixed(2)),
      img: ev.target.result,
      file: file.name,
      ownerId: currentUserId,
      reviews: [],
      created: Date.now()
    };
    items.unshift(newItem);
    // clear form
    document.getElementById('pub-title').value = '';
    document.getElementById('pub-desc').value = '';
    document.getElementById('pub-price').value = '';
    document.getElementById('pub-img').value = '';
    document.getElementById('pub-file').value = '';
    updateCommission();
    showToast('Товар опубликован');
    // go to home and render
    switchTab('home', document.querySelectorAll('.tabs button')[0]);
    renderMarket();
  };
  reader.readAsDataURL(preview);
});

/* ===========================
   Seller slide (profile)
   =========================== */
const profileSlide = document.getElementById('profile-slide');
const profileSlideContent = document.getElementById('profile-slide-content');
const slideHandle = document.getElementById('slide-handle');

function openSellerSlide(ownerId){
  const seller = users[ownerId] || { id: ownerId, username:'', name:'Unknown', avatar:'https://via.placeholder.com/100', joined:'—', trades:0, visibility:{username:true,joined:true,trades:true,rating:true} };
  // build content
  const sellerRating = computeSellerRating(ownerId);
  profileSlideContent.innerHTML = `
    <div class="profile-header">
      <img src="${escapeHtml(seller.avatar)}" alt="${escapeHtml(seller.name)}">
      <div class="profile-info">
        <div class="profile-name">${escapeHtml(seller.name)}</div>
        ${seller.visibility.username?`<div class="profile-meta">${escapeHtml(seller.username)}</div>`:''}
        ${seller.visibility.rating?`<div class="profile-meta">★ ${sellerRating.avg.toFixed(1)} (${sellerRating.count})</div>`:''}
        ${seller.visibility.trades?`<div class="profile-meta">Объем торгов: ${seller.trades || 0} TON</div>`:''}
        ${seller.visibility.joined?`<div class="profile-meta">На TonFiles с ${seller.joined}</div>`:''}
      </div>
    </div>
    <h3 style="margin-top:6px">Товары продавца</h3>
    <div class="grid">
      ${items.filter(it=>it.ownerId===ownerId).map(it=>`
        <div class="card card-seller" data-id="${it.id}">
          <div class="image-wrap"><img src="${escapeHtml(it.img)}" alt="${escapeHtml(it.name)}"></div>
          <div class="card-body">
            <div>
              <div class="title">${escapeHtml(it.name)}</div>
              <div class="desc">${escapeHtml(it.desc)}</div>
            </div>
            <div>
              <div class="row-info"><div>★ ${(avgAndCount(it.reviews).avg? (Math.round(avgAndCount(it.reviews).avg*10)/10).toFixed(1):'—')} (${avgAndCount(it.reviews).count})</div><div class="price">${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></div></div>
              <div class="btn-row">
                ${ (it.ownerId===currentUserId) ? `<button class="btn btn-primary btn-open" data-id="${it.id}">Мой товар</button>` : `<button class="btn btn-primary btn-open" data-id="${it.id}">Купить • ${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></button>` }
              </div>
            </div>
          </div>
        </div>`).join('')}
    </div>
  `;
  // show slide
  profileSlide.classList.add('show');
  profileSlide.setAttribute('aria-hidden','false');

  // wire up close by handle and clicking outside on slide (but clicking on content should not close)
  const onDocClick = (e)=>{
    if(!profileSlide.contains(e.target)) {
      closeProfileSlide();
    }
  };
  // handle click to close
  slideHandle.onclick = closeProfileSlide;
  // attach open modal handlers for the seller's product cards
  setTimeout(()=>{
    profileSlide.querySelectorAll('.btn-open').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const id = parseInt(b.dataset.id);
        openItemModal(id);
      });
    });
    profileSlide.querySelectorAll('.card-seller').forEach(card=>{
      card.addEventListener('click', ()=> openItemModal(parseInt(card.dataset.id)));
    });
  },0);
}

function closeProfileSlide(){
  profileSlide.classList.remove('show');
  profileSlide.setAttribute('aria-hidden','true');
}

/* compute seller aggregated rating */
function computeSellerRating(ownerId){
  const sellerItems = items.filter(it=>it.ownerId===ownerId);
  let sum=0, cnt=0;
  sellerItems.forEach(it=>{
    (it.reviews||[]).forEach(r=>{ sum+=r.value; cnt++; });
  });
  return { avg: cnt? (sum/cnt):0, count: cnt };
}

/* ===========================
   Profile page (self)
   =========================== */
function renderProfilePage(){
  const u = users[currentUserId];
  const cont = document.getElementById('profile-view');
  const sellerRating = computeSellerRating(currentUserId);
  cont.innerHTML = `
    <div class="profile-header">
      <img src="${escapeHtml(u.avatar)}" alt="${escapeHtml(u.name)}">
      <div class="profile-info">
        <div class="profile-name">${escapeHtml(u.name)}</div>
        ${u.visibility.username?`<div class="profile-meta">${escapeHtml(u.username)}</div>`:''}
        ${u.visibility.rating?`<div class="profile-meta">★ ${sellerRating.avg.toFixed(1)} (${sellerRating.count})</div>`:''}
        ${u.visibility.trades?`<div class="profile-meta">Объем торгов: ${u.trades} TON</div>`:''}
        ${u.visibility.joined?`<div class="profile-meta">На TonFiles с ${u.joined}</div>`:''}
        <button class="profile-edit" id="btn-edit-profile">Редактировать профиль</button>
      </div>
    </div>
    <h3 style="margin-top:10px">Мои товары</h3>
    <div class="grid">${ items.filter(it=>it.ownerId===currentUserId).map(it=>`
      <div class="card" onclick="openItemModal(${it.id})">
        <div class="image-wrap"><img src="${escapeHtml(it.img)}" alt="${escapeHtml(it.name)}"></div>
        <div class="card-body">
          <div>
            <div class="title">${escapeHtml(it.name)}</div>
            <div class="desc">${escapeHtml(it.desc)}</div>
          </div>
          <div>
            <div class="row-info"><div>★ ${(avgAndCount(it.reviews).avg? (Math.round(avgAndCount(it.reviews).avg*10)/10).toFixed(1):'—')} (${avgAndCount(it.reviews).count})</div><div class="price">${toMoney(it.price)} <img class="ton-icon" src="ton1.svg" alt="TON"></div></div>
            <div class="btn-row"><button class="btn btn-primary btn-open" data-id="${it.id}">Мой товар</button><button class="btn btn-danger btn-del" data-id="${it.id}">Удалить</button></div>
          </div>
        </div>
      </div>`).join('') }</div>
  `;
  // hook edit
  const editBtn = document.getElementById('btn-edit-profile');
  if(editBtn) editBtn.addEventListener('click', openProfileEditModal);
  // attach card buttons
  setTimeout(()=>{
    document.querySelectorAll('.btn-open').forEach(b=> b.addEventListener('click', ev=>{ ev.stopPropagation(); openItemModal(parseInt(b.dataset.id)); }));
    document.querySelectorAll('.btn-del').forEach(b=> b.addEventListener('click', ev=>{ ev.stopPropagation(); deleteItem(parseInt(b.dataset.id)); }));
  },0);
}

/* profile edit modal */
const profileEdit = document.getElementById('profile-edit');
const profileEditCard = document.getElementById('profile-edit-card');

function openProfileEditModal(){
  const u = users[currentUserId];
  profileEditCard.innerHTML = `
    <h3>Редактирование профиля</h3>
    <label>Имя</label><input id="edit-name" type="text" value="${escapeHtml(u.name)}" />
    <label>Фото профиля</label><input id="edit-avatar" type="file" accept="image/*" />
    <label>Отображать</label>
    <div style="margin-top:6px">
      <label><input type="checkbox" id="v-username" ${u.visibility.username?'checked':''}> Юзернейм</label><br>
      <label><input type="checkbox" id="v-rating" ${u.visibility.rating?'checked':''}> Рейтинг</label><br>
      <label><input type="checkbox" id="v-trades" ${u.visibility.trades?'checked':''}> Объем торгов</label><br>
      <label><input type="checkbox" id="v-joined" ${u.visibility.joined?'checked':''}> Дата регистрации</label>
    </div>
    <button class="btn btn-primary" id="save-profile-btn">Сохранить</button>
  `;
  profileEdit.classList.add('show');
  // save handler
  document.getElementById('save-profile-btn').onclick = saveProfileEdit;
  // clicking outside dismiss
  profileEdit.onclick = (e)=>{ if(e.target===profileEdit) profileEdit.classList.remove('show'); };
}

function saveProfileEdit(){
  const u = users[currentUserId];
  u.name = document.getElementById('edit-name').value || u.name;
  u.visibility.username = document.getElementById('v-username').checked;
  u.visibility.rating = document.getElementById('v-rating').checked;
  u.visibility.trades = document.getElementById('v-trades').checked;
  u.visibility.joined = document.getElementById('v-joined').checked;
  const f = document.getElementById('edit-avatar').files[0];
  if(f){
    const r = new FileReader();
    r.onload = ()=>{ u.avatar = r.result; profileEdit.classList.remove('show'); renderProfilePage(); showToast('Профиль обновлён'); };
    r.readAsDataURL(f);
  } else {
    profileEdit.classList.remove('show');
    renderProfilePage();
    showToast('Профиль обновлён');
  }
}

/* ===========================
   Tabs
   =========================== */
function switchTab(id, btn){
  document.querySelectorAll('.section').forEach(s=> s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
  if(id==='home') renderMarket();
  if(id==='publish'){ /* nothing extra */ }
  if(id==='profile') renderProfilePage();
}

/* ===========================
   Utility: wire apply button and enter keys
   =========================== */
document.getElementById('apply-btn').addEventListener('click', ()=> renderMarket());
document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); renderMarket(); }});
document.getElementById('id-search').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); renderMarket(); }});
document.getElementById('min-price').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); renderMarket(); }});
document.getElementById('max-price').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); renderMarket(); }});

/* ===========================
   Fix ton icon sizing on buttons (ensure 1em)
   =========================== */
function fixTonIcons(){
  document.querySelectorAll('.ton-icon').forEach(img=>{
    // ensure consistent height relative to surrounding text by setting font-size inheritance via CSS
    img.style.height = '1em';
    img.style.width = 'auto';
    img.style.display = 'inline-block';
    img.style.verticalAlign = 'middle';
  });
}

/* ===========================
   Init
   =========================== */
(function init(){
  // wire handlers that rely on other functions
  // publish form commission
  updateCommission();
  // initial render
  renderMarket();
  renderProfilePage();
  fixTonIcons();

  // close slide when clicking outside (already handled per openSellerSlide)
  // ensure slide handle closes
  slideHandle.addEventListener('click', closeProfileSlide);

  // keep ton icons fixed periodically (in case new buttons created)
  const iconObserver = new MutationObserver(()=> fixTonIcons());
  iconObserver.observe(document.body, { childList: true, subtree: true });
})();
</script>
</body>
</html>
