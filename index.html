<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tonfiles Market — demo</title>
<style>
  /* basic */
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select:none; user-select:none;}
  body{margin:0; font-family:Inter, Arial, Helvetica, sans-serif; background:#000; color:#fff; -webkit-font-smoothing:antialiased;}
  a,button,input,textarea{outline:none}
  /* header */
  .wrap{max-width:1100px;margin:0 auto;padding:12px;}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#111;border:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:34px}
  .balance{font-weight:800;color:#bfffbf;display:flex;align-items:center;gap:8px}
  .balance img{width:14px;height:14px}
  main{max-width:1100px;margin:16px auto;padding:0 12px 120px}
  /* tabs bottom */
  .tabs{position:fixed;left:0;right:0;bottom:0;background:#111;border-top:2px solid #0eff00;display:flex;z-index:90}
  .tabs button{flex:1;padding:12px;border:0;background:transparent;color:#fff;cursor:pointer}
  .tabs button.active{color:#0eff00;font-weight:800}
  /* search / filters layout */
  .search-block{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
  .row1{display:flex;gap:10px;flex-wrap:wrap}
  .row2{display:flex;gap:10px;flex-wrap:wrap}
  .input, .select{padding:10px;border-radius:10px;background:#111;border:1px solid rgba(14,255,0,0.08);color:#fff;min-width:120px}
  .input{flex:1;min-width:160px}
  .select{width:200px}
  .btn-apply{padding:10px 12px;border-radius:10px;background:#0eff00;color:#000;font-weight:800;border:0;cursor:pointer}
  /* grid */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  @media(max-width:860px){.grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}}
  .card{background:#111;border:1px solid rgba(14,255,0,0.08);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;position:relative;height:340px}
  .card .price-badge{position:absolute;right:10px;top:10px;background:#000;border:1px solid rgba(14,255,0,0.12);padding:6px 8px;border-radius:10px;font-weight:800}
  .card img{width:100%;height:180px;object-fit:cover;display:block}
  .card-body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:800;font-size:16px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .desc{color:#bfc7d9;font-size:13px;line-height:1.2;height:36px;overflow:hidden;word-break:break-word}
  .rating-row{display:flex;align-items:center;gap:8px;font-weight:700;color:#ffd54d}
  .rating-row .count{color:#aaa;font-weight:600;font-size:13px}
  .buy-row{margin-top:auto;display:flex;gap:8px}
  .buy-btn{flex:1;background:#0eff00;color:#000;padding:10px;border-radius:10px;border:0;font-weight:900;cursor:pointer}
  .bought{flex:1;background:#333;color:#0eff00;padding:10px;border-radius:10px;border:0;font-weight:800;cursor:default}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:200}
  .modal.show{display:flex}
  .modal-card{background:#111;border-radius:12px;padding:16px;border:1px solid rgba(14,255,0,0.08);width:94%;max-width:800px;display:flex;gap:16px;flex-wrap:wrap}
  .modal-left{flex:0 0 360px}
  .modal-left img{width:100%;height:360px;object-fit:cover;border-radius:8px}
  .modal-right{flex:1;display:flex;flex-direction:column}
  .modal-right h3{margin:0}
  .modal-actions{margin-top:auto;display:flex;gap:10px;flex-wrap:wrap}

  /* profile */
  .profile-tabs{display:flex;gap:8px;margin-bottom:12px}
  .profile-tabs button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#fff;cursor:pointer}
  .profile-tabs button.active{background:#0eff00;color:#000;font-weight:800}
  .profile-subsearch{margin-bottom:10px}
  .profile-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}

  /* form */
  #add-form{max-width:640px;margin:0 auto;background:transparent}
  .form-group{margin-bottom:12px}
  .form-label{display:block;margin-bottom:6px;color:#0eff00;font-weight:700}
  .input-file{background:#111;border:1px dashed rgba(14,255,0,0.06);padding:10px;border-radius:8px;color:#fff}

  /* toast */
  .toast{position:fixed;right:18px;bottom:90px;background:#111;border:1px solid #0eff00;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .45s;z-index:300}
  .toast.show{opacity:1}

  /* small helpers */
  .muted{color:#9aa3c7}
  .center{text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><img src="tonfiles.svg" alt="logo"><div style="font-weight:900">Tonfiles Market</div></div>
      <div class="balance"><span id="balance">1000.00</span><img src="ton1.svg" alt="TON"></div>
    </header>

    <main>
      <!-- HOME -->
      <section id="home" class="section active">
        <div class="search-block">
          <div class="row1">
            <input id="q" class="input" placeholder="Поиск по товарам..." />
            <select id="sort" class="select">
              <option value="newest">Последние</option>
              <option value="price_asc">Цена: по возрастанию</option>
              <option value="price_desc">Цена: по убыванию</option>
              <option value="best">Отзывы: лучшие</option>
              <option value="count">Отзывы: количество</option>
            </select>
            <button class="btn-apply" onclick="render()">Применить</button>
          </div>
          <div class="row2">
            <input id="min" class="input" type="number" step="0.01" placeholder="Мин. цена" />
            <input id="max" class="input" type="number" step="0.01" placeholder="Макс. цена" />
          </div>
        </div>

        <div id="market" class="grid"></div>
      </section>

      <!-- ADD -->
      <section id="add" class="section">
        <div id="add-form">
          <h2 class="center">Публикация объявления</h2>
          <div class="form-group"><label class="form-label">Название</label><input id="addName" class="input" /></div>
          <div class="form-group"><label class="form-label">Описание</label><textarea id="addDesc" class="input" style="min-height:100px;resize:vertical"></textarea></div>
          <div class="form-group"><label class="form-label">Цена (TON)</label><input id="addPrice" class="input" type="number" step="0.01" oninput="updateNet()" /><div id="net" class="muted" style="margin-top:6px"></div></div>
          <div class="form-group"><label class="form-label">Превью (картинка)</label><input id="addPreview" type="file" class="input-file" accept="image/*"></div>
          <div class="form-group"><label class="form-label">Файл для выдачи</label><input id="addFile" type="file" class="input-file"></div>
          <div style="display:flex;gap:10px"><button onclick="publish()">Опубликовать</button><button style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px" onclick="clearAdd()">Очистить</button></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="section">
        <h2 style="text-align:center">Профиль</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
          <div style="padding:12px;border-radius:10px;border:1px solid rgba(14,255,0,0.06);min-width:240px">
            <div style="font-weight:800">Реферальная система</div>
            <div class="muted" style="margin-top:6px">2% от трат рефералов</div>
            <div style="margin-top:8px;font-weight:800;color:#bfffbf">Баланс: <span id="refBal">0.00</span> <img src="ton1.svg" style="width:12px;height:12px;vertical-align:middle" /></div>
            <div style="margin-top:10px"><button onclick="withdrawRef()">Вывести</button></div>
          </div>

          <div style="flex:1;min-width:260px">
            <div class="profile-tabs">
              <button id="tabPurchases" class="active" onclick="switchProfile('purchases')">Мои покупки</button>
              <button id="tabMyItems" onclick="switchProfile('myitems')">Мои товары</button>
            </div>

            <div id="purchases" class="profile-section active">
              <div class="profile-subsearch"><input id="searchPurchases" class="input" placeholder="Поиск по покупкам..." oninput="renderProfile()" /></div>
              <div id="purchasesGrid" class="profile-grid"></div>
              <div id="purchasesEmpty" class="muted center" style="padding:12px">Ничего не найдено</div>
            </div>

            <div id="myitems" class="profile-section">
              <div class="profile-subsearch"><input id="searchMyItems" class="input" placeholder="Поиск по моим товарам..." oninput="renderProfile()" /></div>
              <div id="myItemsGrid" class="profile-grid"></div>
              <div id="myItemsEmpty" class="muted center" style="padding:12px">Ничего не найдено</div>
            </div>

          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- bottom tabs -->
  <div class="tabs">
    <button id="bHome" class="active" onclick="goTab('home', this)">Главная</button>
    <button id="bAdd" onclick="goTab('add', this)">Добавить</button>
    <button id="bProfile" onclick="goTab('profile', this)">Профиль</button>
  </div>

  <!-- modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-left"><img id="modalImg" src="" alt=""></div>
      <div class="modal-right">
        <h3 id="modalTitle"></h3>
        <div id="modalDesc" class="muted" style="margin-top:8px"></div>
        <div style="margin-top:12px;font-weight:800">Цена: <span id="modalPrice"></span> <img src="ton1.svg" style="width:14px;height:14px;vertical-align:middle"></div>

        <div id="modalActions" class="modal-actions"></div>

        <div id="modalRating" style="margin-top:12px"></div>

        <div style="margin-top:12px"><button onclick="closeModal()" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px">Закрыть</button></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* -----------------------
   Demo in-memory state
   ----------------------- */
let balance = 1000.00;
let refBalance = 0.00;
let userId = 1;               // demo current user
let purchases = [];          // array of item ids purchased by current user
let myItems = [];            // array of item ids created by current user
let rated = [];              // item ids user already rated (only one rating allowed)

/* demo items */
let items = [
  { id:101, name:"Скрипт Telegram Bot", desc:"Полностью рабочий бот с оплатами", price:15.00, img:"https://via.placeholder.com/800x600?text=Bot", file:"bot.zip", ownerId:2, reviews:[5] },
  { id:102, name:"Видеоурок по дизайну", desc:"UI/UX советы", price:8.50, img:"https://via.placeholder.com/800x600?text=Design", file:"design.mp4", ownerId:3, reviews:[5,4] },
  { id:103, name:"NFT шаблон", desc:"Коллекционный PSD шаблон", price:22.00, img:"https://via.placeholder.com/800x600?text=NFT", file:"nft.psd", ownerId:4, reviews:[4,3] },
  { id:104, name:"React шаблон", desc:"Адаптивный шаблон сайта", price:18.25, img:"https://via.placeholder.com/800x600?text=React", file:"site.zip", ownerId:5, reviews:[] },
  { id:105, name:"Python API example", desc:"REST API skeleton", price:12.00, img:"https://via.placeholder.com/800x600?text=API", file:"api.py", ownerId:6, reviews:[5] }
];

/* Helper */
const $ = id => document.getElementById(id);
function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function avg(arr){ return (arr && arr.length) ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0; }
function cut(s,n=45){ return s.length>n ? s.slice(0,n-1)+'…' : s; }

/* Render market */
function render(){
  $('balance').textContent = balance.toFixed(2);
  $('refBal').textContent = refBalance.toFixed(2);

  const q = ($('q').value || '').trim().toLowerCase();
  const min = parseFloat($('min').value) || 0;
  const max = parseFloat($('max').value) || Infinity;
  const sort = $('sort').value;

  let list = items.filter(it=>{
    const hay = (it.name+' '+(it.desc||'')).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(it.price < min || it.price > max) return false;
    return true;
  });

  if(sort==='price_asc') list.sort((a,b)=>a.price-b.price);
  else if(sort==='price_desc') list.sort((a,b)=>b.price-a.price);
  else if(sort==='best') list.sort((a,b)=> avg(b.reviews) - avg(a.reviews) );
  else if(sort==='count') list.sort((a,b)=> b.reviews.length - a.reviews.length );
  else list.sort((a,b)=> b.id - a.id); // newest

  const grid = $('market'); grid.innerHTML='';

  if(list.length===0){
    const no=document.createElement('div'); no.className='muted center'; no.style.padding='24px'; no.textContent='Ничего не найдено';
    grid.appendChild(no);
    return;
  }

  list.forEach(it=>{
    const a = avg(it.reviews);
    const card = document.createElement('div'); card.className='card';
    // price badge
    const pb = document.createElement('div'); pb.className='price-badge'; pb.innerHTML = `${it.price.toFixed(2)} <img src="ton1.svg" style="width:12px;height:12px">`;
    card.appendChild(pb);
    // image
    const img = document.createElement('img'); img.src = it.img; img.alt = it.name;
    card.appendChild(img);
    // body
    const body = document.createElement('div'); body.className='card-body';
    const t = document.createElement('div'); t.className='title'; t.textContent = cut(it.name, 36);
    const d = document.createElement('div'); d.className='desc'; d.textContent = cut(it.desc, 80);
    body.appendChild(t); body.appendChild(d);

    // rating row displayed above buy-button left
    const ratingRow = document.createElement('div'); ratingRow.className='rating-row';
    ratingRow.innerHTML = `⭐ ${a.toFixed(1)} <span class="count">(${it.reviews.length})</span>`;
    body.appendChild(ratingRow);

    // buy row
    const buyWrap = document.createElement('div'); buyWrap.className='buy-row';
    const boughtFlag = purchases.includes(it.id);
    const ownerFlag = (it.ownerId === userId);
    const btn = document.createElement('button');
    if(ownerFlag) { btn.className='bought'; btn.textContent='Мой товар'; }
    else if(boughtFlag) { btn.className='bought'; btn.textContent='Приобретено'; }
    else { btn.className='buy-btn'; btn.textContent=`Купить ${it.price.toFixed(2)} TON`; btn.onclick = ()=> openItemModal(it.id); }
    buyWrap.appendChild(btn);
    body.appendChild(buyWrap);

    card.appendChild(body);
    grid.appendChild(card);
  });
}

/* Open modal for item (for buy or view) */
function openItemModal(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  $('modalTitle').textContent = it.name;
  $('modalImg').src = it.img;
  $('modalDesc').textContent = it.desc;
  $('modalPrice').textContent = it.price.toFixed(2);

  const actions = $('modalActions'); actions.innerHTML='';

  const ownerFlag = (it.ownerId === userId);
  const boughtFlag = purchases.includes(it.id);

  if(ownerFlag){ const b=document.createElement('button'); b.textContent='Мой товар'; b.className='bought'; actions.appendChild(b); }
  else if(boughtFlag){
    const b = document.createElement('button'); b.textContent='Приобретено'; b.className='bought'; actions.appendChild(b);
    const f = document.createElement('button'); f.textContent='Получить файл'; f.className='btn-apply'; f.onclick=()=> downloadDemoFile(it); actions.appendChild(f);
  } else {
    const buy = document.createElement('button'); buy.textContent=`Купить ${it.price.toFixed(2)} TON`; buy.className='btn-apply'; buy.onclick=()=> doBuy(it.id); actions.appendChild(buy);
  }

  // rating shown, but actual rating action only in profile/purchases
  const mr = $('modalRating'); mr.innerHTML = `Рейтинг: ${avg(it.reviews).toFixed(1)} ⭐ (${it.reviews.length})`;
  $('modal').classList.add('show');
}

function closeModal(){ $('modal').classList.remove('show'); }

/* buy action */
function doBuy(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  if(balance < it.price){ showToast('Недостаточно средств'); return; }
  balance = Math.round((balance - it.price)*100)/100;
  refBalance = Math.round((refBalance + it.price*0.02)*100)/100;
  purchases.push(it.id);
  showToast('Покупка успешна — теперь вы можете оценить товар в Профиле → Мои покупки');
  closeModal();
  render();
}

/* download demo file (generates tiny file) */
function downloadDemoFile(item){
  const blob = new Blob([`Демо-файл: ${item.file}\n(это демонстрация)`], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = item.file || 'file.txt'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* publish */
function updateNet(){ const p = parseFloat($('addPrice').value) || 0; $('net').textContent = `Вы получите ${(p*0.9).toFixed(2)} TON (после комиссии 10%)`; }
function publish(){
  const name = $('addName').value.trim();
  const desc = $('addDesc').value.trim();
  const price = parseFloat($('addPrice').value) || 0;
  const preview = $('addPreview').files[0];
  const file = $('addFile').files[0];
  if(!name || !desc || !price || !preview || !file){ showToast('Заполните все поля и загрузите файлы'); return; }
  const r = new FileReader();
  r.onload = (e) => {
    const newItem = {
      id: Date.now() + Math.floor(Math.random()*1000),
      name, desc, price, img: e.target.result, file: file.name, ownerId: userId, reviews: []
    };
    items.unshift(newItem);
    myItems.push(newItem.id);
    showToast('Товар опубликован (в демо-хранилище)');
    clearAdd();
    goTab('home', $('bHome'));
    render();
  };
  r.readAsDataURL(preview);
}
function clearAdd(){ $('addName').value=''; $('addDesc').value=''; $('addPrice').value=''; $('addPreview').value=''; $('addFile').value=''; $('net').textContent=''; }

/* profile: switch and render */
function switchProfile(which){
  $('tabPurchases').classList.remove('active'); $('tabMyItems').classList.remove('active');
  if(which==='purchases'){ $('tabPurchases').classList.add('active'); $('purchases').classList.add('active'); $('myitems').classList.remove('active'); }
  else { $('tabMyItems').classList.add('active'); $('myitems').classList.add('active'); $('purchases').classList.remove('active'); }
  renderProfile();
}
function renderProfile(){
  $('refBal').textContent = refBalance.toFixed(2);
  // purchases list
  const q = ($('searchPurchases').value || '').trim().toLowerCase();
  const pgrid = $('purchasesGrid'); pgrid.innerHTML='';
  const ps = items.filter(it => purchases.includes(it.id)).filter(it => (it.name+it.desc).toLowerCase().includes(q));
  if(ps.length===0) $('purchasesEmpty').style.display='block'; else $('purchasesEmpty').style.display='none';
  ps.forEach(it=>{
    const a = avg(it.reviews);
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src=it.img; card.appendChild(img);
    const body = document.createElement('div'); body.className='card-body';
    const title = document.createElement('div'); title.className='title'; title.textContent = cut(it.name,36);
    const desc = document.createElement('div'); desc.className='desc'; desc.textContent=cut(it.desc,80);
    body.appendChild(title); body.appendChild(desc);
    // rating display and rate-button
    const ratingRow = document.createElement('div'); ratingRow.className='rating-row'; ratingRow.innerHTML = `⭐ ${a.toFixed(1)} <span class="count">(${it.reviews.length})</span>`;
    body.appendChild(ratingRow);
    // rating button (only if not yet rated)
    const rateBtn = document.createElement('button');
    if(rated.includes(it.id)) { rateBtn.textContent='Оценено'; rateBtn.className='bought'; }
    else { rateBtn.textContent='Оценить'; rateBtn.className='buy-btn'; rateBtn.onclick = ()=> promptRate(it.id); }
    body.appendChild(rateBtn);

    // download file
    const getBtn = document.createElement('button'); getBtn.textContent='Получить файл'; getBtn.className='btn-apply'; getBtn.style.background='#222'; getBtn.style.color='#fff';
    getBtn.onclick = ()=> downloadDemoFile(it);
    body.appendChild(getBtn);

    card.appendChild(body);
    pgrid.appendChild(card);
  });

  // my items
  const qm = ($('searchMyItems').value || '').trim().toLowerCase();
  const mg = $('myItemsGrid'); mg.innerHTML='';
  const mylist = items.filter(it => it.ownerId===userId).filter(it => (it.name+it.desc).toLowerCase().includes(qm));
  if(mylist.length===0) $('myItemsEmpty').style.display='block'; else $('myItemsEmpty').style.display='none';
  mylist.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const img=document.createElement('img'); img.src=it.img; card.appendChild(img);
    const body=document.createElement('div'); body.className='card-body';
    const title=document.createElement('div'); title.className='title'; title.textContent=cut(it.name,36);
    const desc=document.createElement('div'); desc.className='desc'; desc.textContent=cut(it.desc,80);
    body.appendChild(title); body.appendChild(desc);
    const rm=document.createElement('button'); rm.textContent='Снять'; rm.className='buy-btn'; rm.onclick=()=> removeMyItem(it.id);
    body.appendChild(rm);
    card.appendChild(body); mg.appendChild(card);
  });
}

/* prompt rate (only from purchases) */
function promptRate(id){
  const r = prompt('Поставьте оценку 1–5 (число):');
  const v = parseInt(r);
  if(!v || v<1 || v>5){ showToast('Некорректная оценка'); return; }
  const it = items.find(x=>x.id===id);
  it.reviews.push(v);
  rated.push(id);
  showToast('Спасибо! Оценка принята');
  renderProfile();
  render();
}

/* remove own item */
function removeMyItem(id){
  if(!confirm('Снять товар?')) return;
  items = items.filter(x=>x.id!==id);
  myItems = myItems.filter(x=>x!==id);
  showToast('Товар снят');
  renderProfile(); render();
}

/* withdraw ref */
function withdrawRef(){ if(refBalance<=0){ showToast('Нет средств'); return; } balance = Math.round((balance+refBalance)*100)/100; refBalance = 0; showToast('Выведено'); render(); }

/* navigation helpers */
function goTab(id, btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(id==='profile') renderProfile();
  render();
}

/* clear add form */
function clearAdd(){ $('addName').value=''; $('addDesc').value=''; $('addPrice').value=''; $('addPreview').value=''; $('addFile').value=''; $('net').textContent=''; }

/* init: sample add current user item for demo */
(function init(){
  // give the user one own item for demo
  const mine = { id:999, name:'Мой гайд (демо)', desc:'Товар, опубликованный пользователем', price:5.00, img:'https://via.placeholder.com/800x600?text=My+Guide', file:'guide.pdf', ownerId:userId, reviews:[5] };
  items.unshift(mine); myItems.push(mine.id);

  // mark one purchase so rating in profile is possible
  purchases.push(101); // we assume 101 exists from initial items if present; if not, ignore

  render();
  renderProfile();
})();

</script>
</body>
</html>
