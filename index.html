<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tonfiles Market</title>
<style>
  * {box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body {margin:0; font-family:Arial, sans-serif; background:#000; color:#fff;}
  header {display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111; border-bottom:2px solid #0eff00;}
  header img {height:30px;}
  header .balance {display:flex; align-items:center; gap:5px; font-weight:bold;}
  header .balance img {width:12px; height:12px; object-fit:contain;}
  main {padding:15px;}
  .search-filter {display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;}
  .search-filter input, .search-filter select {padding:8px; border:1px solid #0eff00; border-radius:5px; background:#111; color:#fff; flex:1; min-width:110px;}
  .search-filter button {padding:8px 12px; border:none; border-radius:5px; background:#0eff00; color:#000; font-weight:bold; cursor:pointer;}
  .tabs {display:flex; justify-content:space-around; position:fixed; bottom:0; left:0; width:100%; background:#111; border-top:2px solid #0eff00;}
  .tabs button {flex:1; padding:10px; background:none; border:none; color:#fff; font-size:14px; cursor:pointer;}
  .tabs button.active {color:#0eff00; font-weight:bold;}
  .section {display:none;}
  .section.active {display:block;}
  .grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px;}
  .card {background:#111; border:1px solid #0eff00; border-radius:8px; display:flex; flex-direction:column; justify-content:space-between; height:280px; overflow:hidden;}
  .card img {width:100%; height:160px; object-fit:cover; border-radius:5px 5px 0 0;}
  .card-content {padding:8px; flex-grow:1;}
  .card-content h3 {font-size:16px; margin:4px 0;}
  .card-content p {font-size:13px; margin:2px 0; color:#ccc;}
  .card button {margin-top:auto; padding:8px; width:100%; background:#0eff00; color:#000; border:none; border-radius:0 0 5px 5px; font-weight:bold; cursor:pointer;}
  .modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:1000;}
  .modal.active {display:flex;}
  .modal-content {background:#111; border:1px solid #0eff00; border-radius:10px; max-width:400px; width:90%; padding:15px; text-align:center;}
  .modal-content img {width:100%; max-height:200px; object-fit:cover; border-radius:5px; margin-bottom:10px;}
  .modal-content button {margin-top:10px; width:100%; padding:10px; border-radius:5px; border:none; font-weight:bold; cursor:pointer;}
  .buy-btn {background:#0eff00; color:#000;}
  .owned-btn {background:#333; color:#0eff00;}
  .file-btn {background:#222; color:#fff;}
  .toast {position:fixed; bottom:70px; right:20px; background:#111; border:1px solid #0eff00; padding:10px 15px; border-radius:5px; opacity:0; transition:opacity 1s; z-index:1000;}
  .toast.show {opacity:1; transition:opacity 0.5s;}
  .stars {font-size:22px; margin:8px 0;}
  .star {cursor:pointer; color:#555;}
  .star.active {color:#0eff00;}
</style>
</head>
<body>
<header>
  <img src="tonfiles.svg" alt="logo">
  <div class="balance"><span id="balance">1000.00</span><img src="ton1.svg" alt="ton"></div>
</header>

<main>
  <section id="home" class="section active">
    <div class="search-filter">
      <input id="search-input" placeholder="Поиск...">
      <input id="min-price" type="number" placeholder="Мин. цена" step="0.01">
      <input id="max-price" type="number" placeholder="Макс. цена" step="0.01">
      <select id="sort">
        <option value="newest">Последние</option>
        <option value="price_asc">Цена: по возрастанию</option>
        <option value="price_desc">Цена: по убыванию</option>
        <option value="best">Отзывы: лучшие</option>
        <option value="count">Отзывы: количество</option>
      </select>
      <button onclick="render()">Применить</button>
    </div>
    <div class="grid" id="market-grid"></div>
  </section>

  <section id="add" class="section">
    <h2>Публикация объявления</h2>
    <div><label>Название</label><input id="add-name"></div>
    <div><label>Описание</label><textarea id="add-desc"></textarea></div>
    <div><label>Цена</label><input id="add-price" type="number" step="0.01"></div>
    <div><label>Изображение</label><input id="add-preview" type="file" accept="image/*"></div>
    <div><label>Файл</label><input id="add-file" type="file"></div>
    <button onclick="publish()">Опубликовать</button>
  </section>

  <section id="profile" class="section">
    <h2>Профиль</h2>
    <p>Мои покупки и товары будут тут.</p>
  </section>
</main>

<div class="tabs">
  <button class="active" onclick="switchTab('home', this)">Главная</button>
  <button onclick="switchTab('add', this)">Добавить</button>
  <button onclick="switchTab('profile', this)">Профиль</button>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modal-name"></h3>
    <img id="modal-img">
    <p id="modal-desc"></p>
    <p><b>Цена:</b> <span id="modal-price"></span> TON</p>
    <div id="modal-actions"></div>
    <div id="modal-rating"></div>
    <button onclick="closeModal()">Закрыть</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let balance=1000;
let userId=1; // текущий пользователь
let items=[
  {id:1,name:"Скрипт Telegram Bot",desc:"Полностью рабочий бот",price:15,img:"https://via.placeholder.com/300x200?text=Bot",file:"bot.zip",ownerId:2,reviews:[5,4]},
  {id:2,name:"Видеоурок по дизайну",desc:"Полезные советы для UI",price:8,img:"https://via.placeholder.com/300x200?text=Design",file:"design.mp4",ownerId:3,reviews:[5,5,4]},
  {id:3,name:"Готовый NFT шаблон",desc:"Шаблон коллекции NFT",price:22,img:"https://via.placeholder.com/300x200?text=NFT",file:"nft.psd",ownerId:4,reviews:[4,3]},
  {id:4,name:"Пример сайта на React",desc:"Красивый адаптивный шаблон",price:18,img:"https://via.placeholder.com/300x200?text=React",file:"site.zip",ownerId:5,reviews:[]},
  {id:5,name:"Мобильное приложение",desc:"Исходники Android-приложения",price:30,img:"https://via.placeholder.com/300x200?text=App",file:"app.apk",ownerId:2,reviews:[5,5,5,4]}
];
let purchases=[], ratedItems=[];

function switchTab(id, btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); render();
}

function publish(){
  let name=document.getElementById('add-name').value;
  let desc=document.getElementById('add-desc').value;
  let price=parseFloat(document.getElementById('add-price').value)||0;
  let imgFile=document.getElementById('add-preview').files[0];
  let file=document.getElementById('add-file').files[0];
  if(!name||!desc||!price||!imgFile||!file){showToast("Заполните все поля");return;}
  let reader=new FileReader();
  reader.onload=e=>{
    items.unshift({id:Date.now(),name,desc,price,img:e.target.result,file:file.name,ownerId:userId,reviews:[]});
    showToast("Товар опубликован"); render();
  };
  reader.readAsDataURL(imgFile);
}

function openModal(item){
  document.getElementById('modal-name').innerText=item.name;
  document.getElementById('modal-img').src=item.img;
  document.getElementById('modal-desc').innerText=item.desc;
  document.getElementById('modal-price').innerText=item.price.toFixed(2);
  let act=document.getElementById('modal-actions');
  act.innerHTML="";
  if(item.ownerId===userId){ act.innerHTML="<button class='owned-btn'>Мой товар</button>"; }
  else if(purchases.includes(item.id)){ act.innerHTML="<button class='owned-btn'>Приобретено</button>"; }
  else act.innerHTML=`<button class='buy-btn' onclick='buy(${item.id})'>Купить</button>`;
  
  let rating=document.getElementById('modal-rating');
  let avg=calcAvg(item.reviews);
  rating.innerHTML=`Рейтинг: ${avg.toFixed(1)} ⭐ (${item.reviews.length} отзывов)`;

  // Возможность поставить звезду (1 раз и не на свой товар)
  if(item.ownerId!==userId && !ratedItems.includes(item.id)){
    let stars=document.createElement("div"); stars.className="stars";
    for(let i=1;i<=5;i++){
      let s=document.createElement("span");
      s.innerText="★"; s.className="star";
      s.onclick=()=>rateItem(item.id,i);
      stars.appendChild(s);
    }
    rating.appendChild(stars);
  }
  document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('modal').classList.remove('active');}

function buy(id){
  let item=items.find(x=>x.id===id);
  if(balance<item.price){showToast("Недостаточно средств");return;}
  balance-=item.price; purchases.push(id);
  showToast("Покупка успешна"); render(); closeModal();
}
function rateItem(id,value){
  let item=items.find(x=>x.id===id);
  item.reviews.push(value);
  ratedItems.push(id);
  showToast("Спасибо за отзыв!");
  render(); closeModal();
}
function calcAvg(arr){if(arr.length===0)return 0; return arr.reduce((a,b)=>a+b,0)/arr.length;}

function showToast(msg){let t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500);}

function render(){
  document.getElementById('balance').innerText=balance.toFixed(2);
  let search=document.getElementById('search-input').value.toLowerCase();
  let min=parseFloat(document.getElementById('min-price').value)||0;
  let max=parseFloat(document.getElementById('max-price').value)||Infinity;
  let sort=document.getElementById('sort').value;

  let list=items.filter(i=>i.name.toLowerCase().includes(search)||i.desc.toLowerCase().includes(search))
                .filter(i=>i.price>=min && i.price<=max);

  if(sort==="price_asc") list.sort((a,b)=>a.price-b.price);
  else if(sort==="price_desc") list.sort((a,b)=>b.price-a.price);
  else if(sort==="best") list.sort((a,b)=>calcAvg(b.reviews)-calcAvg(a.reviews));
  else if(sort==="count") list.sort((a,b)=>b.reviews.length-a.reviews.length);
  else list.sort((a,b)=>b.id-a.id); // последние

  let grid=document.getElementById('market-grid');
  grid.innerHTML="";
  list.forEach(it=>{
    let avg=calcAvg(it.reviews);
    let c=document.createElement('div');
    c.className="card";
    c.innerHTML=`<img src="${it.img}"><div class="card-content"><h3>${it.name}</h3><p>${it.desc}</p><p>⭐ ${avg.toFixed(1)} (${it.reviews.length})</p></div>`;
    let b=document.createElement('button');
    b.textContent = it.ownerId===userId ? "Мой товар" : purchases.includes(it.id) ? "Приобретено" : `Купить ${it.price.toFixed(2)} TON`;
    b.onclick=()=>openModal(it);
    c.appendChild(b); grid.appendChild(c);
  });
}
render();
</script>
</body>
</html>
