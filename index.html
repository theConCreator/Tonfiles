<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TONFiles Market</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow-x: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #0eff00;
    }
    header img {
      height: 28px;
    }
    header .balance {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    header .balance img {
      width: 14px;
      height: 14px;
    }
    main {
      padding: 20px;
      padding-bottom: 80px;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      background: #111;
      border-top: 1px solid #0eff00;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border-right: 1px solid #222;
    }
    .tab.active {
      background: #0eff00;
      color: #000;
      font-weight: bold;
    }
    .tab:last-child {
      border-right: none;
    }
    .hidden {
      display: none;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .toolbar input, .toolbar select {
      padding: 6px;
      border: 1px solid #0eff00;
      border-radius: 4px;
      background: #111;
      color: #fff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }
    .card {
      background: #111;
      border: 1px solid #0eff00;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    .card-content {
      padding: 8px;
    }
    .card-title {
      font-size: 15px;
      font-weight: bold;
      margin: 4px 0;
      word-break: break-word;
    }
    .card-desc {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 6px;
      word-break: break-word;
    }
    .rating {
      display: flex;
      gap: 2px;
      margin-bottom: 6px;
    }
    .rating span {
      cursor: pointer;
      font-size: 16px;
      color: #555;
    }
    .rating span.active {
      color: #0eff00;
    }
    .btn {
      padding: 8px;
      border: none;
      border-top: 1px solid #0eff00;
      background: #0eff00;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }
    .btn img {
      width: 14px;
      height: 14px;
    }
    .btn:disabled {
      background: #444;
      color: #aaa;
      cursor: not-allowed;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #111;
      border: 1px solid #0eff00;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
    }
    .toast {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: #0eff00;
      color: #000;
      padding: 10px 15px;
      border-radius: 6px;
      opacity: 1;
      transition: opacity 1s;
    }
  </style>
</head>
<body>
  <header>
    <img src="tonfiles.svg" alt="TONFiles">
    <div class="balance"><img src="ton1.svg" alt="TON"> <span id="balance">1000</span></div>
  </header>

  <main>
    <!-- Главная -->
    <section id="home">
      <div class="toolbar">
        <input type="text" id="searchInput" placeholder="Поиск...">
        <select id="sortSelect">
          <option value="default">Сортировка</option>
          <option value="priceAsc">Цена ↑</option>
          <option value="priceDesc">Цена ↓</option>
          <option value="rating">По рейтингу</option>
        </select>
      </div>
      <div class="grid" id="productGrid"></div>
    </section>

    <!-- Добавить -->
    <section id="add" class="hidden">
      <h2>Опубликовать товар</h2>
      <input type="text" id="titleInput" placeholder="Название"><br><br>
      <textarea id="descInput" placeholder="Описание"></textarea><br><br>
      <input type="number" id="priceInput" placeholder="Цена (TON)" step="0.01"><br><br>
      <p id="commissionText"></p>
      <input type="file" id="previewInput"><br><br>
      <input type="file" id="fileInput"><br><br>
      <button class="btn" onclick="publishProduct()">Опубликовать</button>
    </section>

    <!-- Профиль -->
    <section id="profile" class="hidden">
      <h2>Профиль</h2>
      <div class="toolbar">
        <input type="text" id="profileSearch" placeholder="Поиск по товарам/покупкам...">
      </div>
      <div>
        <button class="tabSub active" onclick="switchProfileTab('purchases')">Мои покупки</button>
        <button class="tabSub" onclick="switchProfileTab('myProducts')">Мои товары</button>
      </div>
      <div id="purchasesTab"></div>
      <div id="myProductsTab" class="hidden"></div>
    </section>
  </main>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('home', this)">Главная</div>
    <div class="tab" onclick="switchTab('add', this)">Добавить</div>
    <div class="tab" onclick="switchTab('profile', this)">Профиль</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <img id="modalImage" src="" style="width:100%; height:150px; object-fit:cover;">
      <p id="modalDesc"></p>
      <div class="rating" id="modalRating"></div>
      <button class="btn" id="modalBuyBtn"></button>
      <button class="btn hidden" id="modalFileBtn">Получить файл</button>
      <button class="btn" onclick="closeModal()">Закрыть</button>
    </div>
  </div>

  <script>
    let balance = 1000;
    let products = [
      {id: 1, title: "Тестовый товар", desc: "Описание тестового товара", price: 25, preview: "https://via.placeholder.com/300", file: "test.txt", owner: "system", rating: 4, ratingCount: 1, purchased: false}
    ];
    let myProducts = [];
    let purchases = [];
    let currentProduct = null;

    const balanceEl = document.getElementById("balance");
    const grid = document.getElementById("productGrid");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const profileSearch = document.getElementById("profileSearch");

    function renderProducts(list = products) {
      grid.innerHTML = "";
      let query = searchInput.value.toLowerCase();
      let filtered = list.filter(p => p.title.toLowerCase().includes(query) || p.desc.toLowerCase().includes(query));

      if (sortSelect.value === "priceAsc") filtered.sort((a,b)=>a.price-b.price);
      if (sortSelect.value === "priceDesc") filtered.sort((a,b)=>b.price-a.price);
      if (sortSelect.value === "rating") filtered.sort((a,b)=> (b.rating||0)-(a.rating||0));

      filtered.forEach(p => {
        let card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.preview}">
          <div class="card-content">
            <div class="card-title">${p.title}</div>
            <div class="card-desc">${p.desc}</div>
            <div class="rating">${renderStars(p.rating||0)}</div>
          </div>
          <button class="btn" onclick="openProduct(${p.id})">
            Купить ${p.price} <img src="ton1.svg">
          </button>
        `;
        grid.appendChild(card);
      });
    }

    function renderStars(rating) {
      let stars = "";
      for (let i=1;i<=5;i++) {
        stars += `<span class="${i<=rating?'active':''}">★</span>`;
      }
      return stars;
    }

    function openProduct(id) {
      currentProduct = products.find(p=>p.id===id);
      document.getElementById("modalTitle").innerText = currentProduct.title;
      document.getElementById("modalImage").src = currentProduct.preview;
      document.getElementById("modalDesc").innerText = currentProduct.desc;
      document.getElementById("modalRating").innerHTML = renderStars(currentProduct.rating||0);
      let buyBtn = document.getElementById("modalBuyBtn");
      let fileBtn = document.getElementById("modalFileBtn");
      if (currentProduct.purchased) {
        buyBtn.innerText = "Приобретено";
        buyBtn.disabled = true;
        fileBtn.classList.remove("hidden");
      } else {
        buyBtn.innerHTML = `Купить ${currentProduct.price} <img src="ton1.svg">`;
        buyBtn.disabled = false;
        fileBtn.classList.add("hidden");
      }
      document.getElementById("productModal").classList.add("active");
    }
    function closeModal(){document.getElementById("productModal").classList.remove("active")}

    function publishProduct(){
      let title = document.getElementById("titleInput").value;
      let desc = document.getElementById("descInput").value;
      let price = parseFloat(document.getElementById("priceInput").value);
      if (!title||!desc||!price) return showToast("Заполните все поля!");
      let newProduct={id:Date.now(),title,desc,price,preview:"https://via.placeholder.com/300",file:"uploaded.txt",owner:"me"};
      products.push(newProduct);
      myProducts.push(newProduct);
      showToast("Товар опубликован!");
      renderProducts();
      renderProfile();
    }

    function switchTab(tab, el){
      document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
      document.getElementById(tab).classList.remove("hidden");
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      el.classList.add("active");
      if(tab==="profile") renderProfile();
    }

    function switchProfileTab(tab){
      document.querySelectorAll("#profile .tabSub").forEach(b=>b.classList.remove("active"));
      event.target.classList.add("active");
      document.getElementById("purchasesTab").classList.add("hidden");
      document.getElementById("myProductsTab").classList.add("hidden");
      document.getElementById(tab+"Tab").classList.remove("hidden");
    }

    function renderProfile(){
      let q = profileSearch.value.toLowerCase();
      let pur = purchases.filter(p=>p.title.toLowerCase().includes(q)||p.desc.toLowerCase().includes(q));
      let myp = myProducts.filter(p=>p.title.toLowerCase().includes(q)||p.desc.toLowerCase().includes(q));

      let purDiv=document.getElementById("purchasesTab");
      let myDiv=document.getElementById("myProductsTab");
      purDiv.innerHTML=""; myDiv.innerHTML="";

      pur.forEach(p=>{
        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`<img src="${p.preview}"><div class="card-content"><div class="card-title">${p.title}</div><div class="card-desc">${p.desc}</div></div>`;
        purDiv.appendChild(card);
      });
      myp.forEach(p=>{
        let card=document.createElement("div");
        card.className="card";
        card.innerHTML=`<img src="${p.preview}"><div class="card-content"><div class="card-title">${p.title}</div><div class="card-desc">${p.desc}</div></div>`;
        myDiv.appendChild(card);
      });
    }

    function showToast(msg){
      let toast=document.createElement("div");
      toast.className="toast";
      toast.innerText=msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.style.opacity=0,1500);
      setTimeout(()=>toast.remove(),2500);
    }

    renderProducts();
  </script>
</body>
</html>
