<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TonFiles Market</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:#000;color:#fff;-webkit-font-smoothing:antialiased;overflow-x:hidden}

/* HEADER */
header{
  position:sticky;top:0;z-index:100;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;background:#0a0a0a;border-bottom:2px solid #36ff12;
}
header img.logo{height:28px}
header .balance{display:flex;align-items:center;gap:6px;font-weight:700}
header .balance img{height:1em;width:auto;vertical-align:middle}

/* MAIN */
main{max-width:1200px;margin:0 auto;padding:16px 14px 100px}

/* TABS */
.tabs{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;justify-content:space-around;background:#0a0a0a;border-top:2px solid #36ff12;
}
.tabs button{flex:1;padding:12px;border:0;background:none;color:#9aa;font-weight:700;cursor:pointer;transition:color .2s}
.tabs button.active{color:#36ff12}

/* SEARCH & FILTERS */
.search-filter{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.search-filter input, .search-filter select, .search-filter button{
  background:#0a0a0a;border:1px solid #36ff12;padding:8px;border-radius:8px;color:#fff;
}
.filter-row{display:flex;gap:10px;flex-wrap:wrap}
.filter-row input{flex:1;min-width:120px}
.search-filter select,.apply-btn{background:#36ff12;color:#000;font-weight:700;cursor:pointer;transition:background .15s}
.apply-btn:hover{background:#4cff2a}

/* GRID */
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}

/* CARD */
.card{
  background:#0a0a0a;border:1px solid #36ff12;border-radius:12px;
  display:flex;flex-direction:column;overflow:hidden;cursor:pointer;transition:transform .16s,box-shadow .16s;
}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(54,255,18,0.08)}
.image-wrap{height:160px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#111}
.image-wrap img{width:100%;height:100%;object-fit:cover}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px;position:relative;flex:1}
.item-id{position:absolute;right:10px;top:8px;font-size:12px;color:#6b6f73}
.title{font-size:15px;font-weight:700;line-height:1.3}
.desc{font-size:13px;color:#bfc7d9;line-height:1.3;max-height:2.6em;overflow:hidden}
.row-info{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#aeb7c9;margin-top:auto}
.row-info img{height:1em;width:auto;vertical-align:middle}
.btn-row{display:flex;gap:8px;margin-top:8px}
.btn{
  flex:1;padding:8px;border-radius:8px;border:0;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap;
}
.btn-primary{background:#36ff12;color:#000}
.btn-danger{background:transparent;border:1px solid #ff5c5c;color:#ff9b9b}

/* MODAL */
.modal{
  position:fixed;left:0;top:0;right:0;bottom:0;display:none;justify-content:center;align-items:center;
  background:rgba(0,0,0,0.8);z-index:400;
}
.modal.show{display:flex}
.modal-card{
  background:#0a0a0a;border:1px solid #36ff12;border-radius:12px;padding:16px;
  width:95%;max-width:520px;max-height:90%;overflow-y:auto;position:relative;
  animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.modal-card img{width:100%;max-height:260px;object-fit:cover;border-radius:8px;margin-bottom:10px}
.modal-title{font-size:18px;margin:0 0 6px}
.modal-desc{color:#bfc7d9;margin:0 0 10px}
.modal-line{display:flex;justify-content:center;align-items:center;gap:8px;color:#dfe6f9;font-weight:700;margin-bottom:10px}
.modal-line img{height:1em;width:auto;vertical-align:middle}
.modal-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.stars{font-size:22px;margin:10px 0;display:flex;justify-content:center;gap:5px}
.star{cursor:pointer;color:#555}
.star.active{color:#36ff12}
.modal-close{
  position:absolute;right:10px;top:10px;background:none;border:none;color:#999;font-size:20px;cursor:pointer;transition:.2s;
}
.modal-close:hover{color:#36ff12}

/* ADD ITEM */
#add form{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:10px}
label{color:#36ff12;font-weight:700;font-size:13px}
input[type=text],input[type=number],textarea{
  background:#0a0a0a;border:1px solid #36ff12;padding:10px;border-radius:8px;color:#fff;font-size:14px
}
input[type=file]{color:#fff}
textarea{min-height:90px;resize:vertical}
#commission-info{color:#9fbf9f;font-size:13px}
#add button[type=submit]{
  background:#36ff12;color:#000;font-weight:700;border:0;border-radius:8px;padding:10px;cursor:pointer;
}
#add button[type=submit]:hover{background:#4cff2a}
.input-error{border-color:#ff5c5c !important}
.error-text{color:#ff5c5c !important}

/* PROFILE */
.profile-box{background:#0a0a0a;border:1px solid #36ff12;padding:12px;border-radius:10px;margin-bottom:12px}
.profile-tabs{display:flex;border-bottom:1px solid #36ff12;margin-bottom:10px}
.profile-tabs button{flex:1;background:none;border:0;color:#dfe;padding:8px;font-weight:700;cursor:pointer}
.profile-tabs button.active{color:#36ff12}
.profile-search{margin-bottom:12px}
.profile-search input{
  width:100%;padding:8px 10px;border-radius:8px;border:1px solid #36ff12;background:#0a0a0a;color:#fff;
}

/* SELLER PROFILE SHEET */
.seller-sheet{
  position:fixed;left:0;right:0;bottom:-100%;z-index:500;
  background:#0a0a0a;border-top:2px solid #36ff12;border-radius:20px 20px 0 0;
  box-shadow:0 -10px 40px rgba(0,0,0,.6);
  transition:bottom .35s ease;
  max-height:90%;overflow-y:auto;padding:16px;
}
.seller-sheet.show{bottom:0}
.seller-header{text-align:center;margin-bottom:12px}
.seller-header img{width:90px;height:90px;border-radius:50%;border:2px solid #36ff12;object-fit:cover}
.seller-header h3{margin:8px 0 4px}
.seller-info{font-size:13px;color:#aeb7c9;margin-bottom:10px}
.seller-sheet .close-btn{
  position:absolute;right:14px;top:10px;background:none;border:none;font-size:22px;color:#999;cursor:pointer;
}
.seller-sheet .close-btn:hover{color:#36ff12}

/* TOAST */
.toast{
  position:fixed;right:18px;bottom:84px;background:#36ff12;color:#000;border-radius:8px;padding:10px 14px;
  opacity:0;transition:opacity 1s;z-index:1000;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<header>
  <img class="logo" src="tonfiles.svg" alt="TONFiles">
  <div class="balance"><span id="balance">1000.00</span><img src="ton1.svg" alt="TON"></div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="section active">
    <div class="search-filter">
      <input id="search-input" placeholder="Поиск...">
      <div class="filter-row">
        <input id="min-price" type="number" placeholder="Мин. цена" step="0.01">
        <input id="max-price" type="number" placeholder="Макс. цена" step="0.01">
        <input id="id-search" type="number" placeholder="ID товара">
      </div>
      <div class="filter-row">
        <select id="sort-select">
          <option value="latest">Последние</option>
          <option value="price-asc">Цена ↑</option>
          <option value="price-desc">Цена ↓</option>
          <option value="best">Отзывы: лучшие</option>
        </select>
        <button class="apply-btn" onclick="render()">Применить</button>
      </div>
    </div>
    <div id="market-grid" class="grid"></div>
    <p id="market-empty" style="text-align:center;color:#9fbf9f;display:none">Не найдено</p>
  </section>

  <!-- ADD -->
  <section id="add" class="section">
    <form onsubmit="event.preventDefault();publish();">
      <label>Название</label><input id="add-name" type="text">
      <label>Описание</label><textarea id="add-desc"></textarea>
      <label>Цена (TON)</label><input id="add-price" type="number" step="0.01" oninput="updateCommission()">
      <div id="commission-info">Вы получите: 0.00 TON (с учётом комиссии 10%)</div>
      <label>Превью</label><input id="add-preview" type="file" accept="image/*">
      <label>Файл</label><input id="add-file" type="file">
      <button type="submit">Опубликовать</button>
    </form>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="section">
    <div class="profile-box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Реферальная программа</div>
          <div style="font-size:13px;color:#9fbf9f">2% от трат рефералов</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800"><span id="ref-balance">0.00</span> <img src="ton1.svg" style="height:1em;vertical-align:middle"></div>
          <button class="btn btn-primary" style="font-size:12px;padding:5px 8px" onclick="withdrawRef()">Вывести</button>
        </div>
      </div>
    </div>
    <div class="profile-tabs">
      <button class="active" onclick="switchProfileTab('purchases',this)">Мои покупки</button>
      <button onclick="switchProfileTab('myitems',this)">Мои товары</button>
    </div>
    <div class="profile-search"><input id="profile-search" placeholder="Поиск..." oninput="render()"></div>
    <div id="purchases" class="profile-section active"><div id="purchases-grid" class="grid"></div></div>
    <div id="myitems" class="profile-section"><div id="myitems-grid" class="grid"></div></div>
  </section>
</main>

<!-- Tabs -->
<div class="tabs">
  <button class="active" onclick="switchTab('home',this)">Главная</button>
  <button onclick="switchTab('add',this)">Добавить</button>
  <button onclick="switchTab('profile',this)">Профиль</button>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="modal-card" id="modal-card"></div></div>

<!-- Seller profile sheet -->
<div id="seller-sheet" class="seller-sheet">
  <button class="close-btn" onclick="closeSeller()">×</button>
  <div id="seller-content"></div>
</div>

<div id="toast" class="toast"></div>

<script>
let balance=1000,refBalance=0,userId=1;
let purchases=[],myItems=[],ratedItems=[],userRatings={};
let items=[
{id:101,name:"Скрипт Telegram Bot",desc:"Полностью рабочий бот",price:15,img:"https://via.placeholder.com/600x400?text=Bot",file:"bot.zip",ownerId:2,reviews:[5,4]},
{id:102,name:"Видеоурок по дизайну",desc:"Советы для UI/UX",price:8,img:"https://via.placeholder.com/600x400?text=Design",file:"design.mp4",ownerId:3,reviews:[5,5,4]},
{id:103,name:"NFT шаблон",desc:"Шаблон NFT-коллекции",price:22,img:"https://via.placeholder.com/600x400?text=NFT",file:"nft.psd",ownerId:4,reviews:[4,3]},
{id:104,name:"React сайт",desc:"Красивый адаптивный шаблон",price:18,img:"https://via.placeholder.com/600x400?text=React",file:"site.zip",ownerId:5,reviews:[]}
];
(function(){const it={id:100,name:"Мой тестовый файл",desc:"Тестовый файл",price:5,img:"https://via.placeholder.com/600x400?text=My+File",file:"test.zip",ownerId:userId,reviews:[5]};items.unshift(it);myItems.push(it);})();

const MIN_PRICE=0.1;
function toMoney(n){return Number(n).toFixed(2)}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500)}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function prepareText(s,len){return escapeHtml(s.length>len?s.slice(0,len)+'…':s)}

function updateCommission(){
  const p=document.getElementById('add-price'),i=document.getElementById('commission-info');
  let v=parseFloat(p.value)||0;
  if(v<MIN_PRICE){
    p.classList.add('input-error');i.classList.add('error-text');
    i.innerHTML=`Минимальная сумма: ${MIN_PRICE} <img src='ton1.svg' style='height:1em;vertical-align:middle'>`;
  }else{
    p.classList.remove('input-error');i.classList.remove('error-text');
    i.innerHTML=`Вы получите: ${(v*0.9).toFixed(2)} TON (с учётом комиссии 10%)`;
  }
}

function publish(){
  const n=document.getElementById('add-name'),d=document.getElementById('add-desc'),p=document.getElementById('add-price'),
        pr=document.getElementById('add-preview'),f=document.getElementById('add-file');
  if(!n.value||!d.value||!p.value||!pr.files[0]||!f.files[0])return showToast('Заполните все поля');
  if(p.value<MIN_PRICE)return showToast('Минимальная цена 0.1 TON');
  const r=new FileReader();
  r.onload=e=>{
    const id=Math.floor(Math.random()*900000)+100000;
    const item={id,name:n.value,desc:d.value,price:+p.value,img:e.target.result,file:f.files[0].name,ownerId:userId,reviews:[]};
    items.unshift(item);myItems.push(item);
    n.value='';d.value='';p.value='';pr.value='';f.value='';
    document.getElementById('commission-info').innerHTML='Вы получите: 0.00 TON (с учётом комиссии 10%)';
    showToast('Товар опубликован');render();
  };
  r.readAsDataURL(pr.files[0]);
}

function buy(id){
  const it=items.find(x=>x.id==id);
  if(balance<it.price)return showToast('Недостаточно средств');
  balance-=it.price;purchases.push(it);renderBalance();
  showToast('Товар куплен');
  openModal(id,true);
}

function renderBalance(){
  document.getElementById('balance').textContent=toMoney(balance);
  document.getElementById('ref-balance').textContent=toMoney(refBalance);
}

function openModal(id,bought=false){
  const it=items.find(x=>x.id==id);
  const m=document.getElementById('modal'),c=document.getElementById('modal-card');
  const r=it.reviews.length?(it.reviews.reduce((a,b)=>a+b,0)/it.reviews.length).toFixed(1):'–';
  const cnt=it.reviews.length;
  let s='';
  if(bought){
    s='<div class="stars">'+[1,2,3,4,5].map(i=>`<span class="star ${userRatings[id]>=i?'active':''}" onclick="rate(${id},${i})">★</span>`).join('')+'</div>';
  }
  c.innerHTML=`<button class='modal-close' onclick='closeModal()'>×</button>
  <img src="${it.img}">
  <h3 class='modal-title'>${prepareText(it.name,50)}</h3>
  <p class='modal-desc'>${escapeHtml(it.desc)}</p>
  <div class='modal-line'>${r} (${cnt}) • ${it.price} <img src='ton1.svg' alt='TON'></div>
  ${bought?`<a href='#' class='btn btn-primary' download='${it.file}'>Скачать (${it.price} TON)</a>${s}`:
    it.ownerId===userId?'<button class="btn btn-danger">Мой товар</button>':
    `<button class='btn btn-primary' onclick='buy(${id})'>Купить за ${it.price} TON</button>`}`;
  m.classList.add('show');
}
function closeModal(){document.getElementById('modal').classList.remove('show')}

function rate(id,v){
  userRatings[id]=v;
  const it=items.find(x=>x.id==id);
  it.reviews.push(v);
  openModal(id,true);
  render();
}

function switchTab(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  render();
}

function switchProfileTab(id,btn){
  document.querySelectorAll('.profile-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.profile-tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  render();
}

function withdrawRef(){if(refBalance<=0)return showToast('Нет средств');balance+=refBalance;refBalance=0;renderBalance();showToast('Вывод успешен')}

function render(){
  const q=document.getElementById('search-input')?.value?.toLowerCase()||'';
  const idf=parseInt(document.getElementById('id-search')?.value)||0;
  const min=parseFloat(document.getElementById('min-price')?.value)||0;
  const max=parseFloat(document.getElementById('max-price')?.value)||Infinity;
  const sort=document.getElementById('sort-select')?.value;
  let list=items.filter(i=>(!idf||i.id==idf)&&(i.price>=min&&i.price<=max)&&(i.name.toLowerCase().includes(q)||i.desc.toLowerCase().includes(q)));
  if(sort==='price-asc')list.sort((a,b)=>a.price-b.price);
  else if(sort==='price-desc')list.sort((a,b)=>b.price-a.price);
  else if(sort==='best')list.sort((a,b)=>(b.reviews.reduce((x,y)=>x+y,0)/b.reviews.length||0)-(a.reviews.reduce((x,y)=>x+y,0)/a.reviews.length||0));
  else list=list.reverse();
  const g=document.getElementById('market-grid');
  g.innerHTML=list.map(i=>{
    const r=i.reviews.length?(i.reviews.reduce((a,b)=>a+b,0)/i.reviews.length).toFixed(1):'–';
    const cnt=i.reviews.length;
    const btn=i.ownerId===userId?'<button class="btn btn-danger">Мой товар</button>':purchases.includes(i)?'<button class="btn btn-primary">Куплено</button>':'<button class="btn btn-primary">Купить</button>';
    return `<div class='card' onclick='openModal(${i.id},${purchases.includes(i)})'>
    <div class='image-wrap'><img src='${i.img}'></div>
    <div class='card-body'>
    <span class='item-id'>#${i.id}</span>
    <div class='title'>${prepareText(i.name,40)}</div>
    <div class='desc'>${prepareText(i.desc,60)}</div>
    <div class='row-info'><span>${r} (${cnt})</span><span>${i.price} <img src='ton1.svg'></span></div>
    <div class='btn-row'>${btn}</div>
    </div></div>`;
  }).join('');
  document.getElementById('market-empty').style.display=list.length?'none':'block';

  // profile
  const myg=document.getElementById('myitems-grid');
  const pur=document.getElementById('purchases-grid');
  myg.innerHTML=myItems.map(i=>renderSmallCard(i)).join('');
  pur.innerHTML=purchases.map(i=>renderSmallCard(i)).join('');
}

function renderSmallCard(i){
  const r=i.reviews.length?(i.reviews.reduce((a,b)=>a+b,0)/i.reviews.length).toFixed(1):'–';
  const cnt=i.reviews.length;
  const btn=i.ownerId===userId?'<button class="btn btn-danger">Мой товар</button>':'<button class="btn btn-primary">Купить</button>';
  return `<div class='card' onclick='openModal(${i.id},${purchases.includes(i)})'>
  <div class='image-wrap'><img src='${i.img}'></div>
  <div class='card-body'>
  <span class='item-id'>#${i.id}</span>
  <div class='title'>${prepareText(i.name,40)}</div>
  <div class='desc'>${prepareText(i.desc,60)}</div>
  <div class='row-info'><span>${r} (${cnt})</span><span>${i.price} <img src='ton1.svg'></span></div>
  <div class='btn-row'>${btn}</div>
  </div></div>`;
}

/* SELLER PROFILE */
function openSeller(id){
  const seller={id,username:'@seller'+id,name:'Продавец '+id,registered:'12.05.2024',volume:'50 TON',rating:'4.9 (23)',avatar:'https://via.placeholder.com/150?text=User'};
  const itemsOf=items.filter(x=>x.ownerId==id);
  const c=document.getElementById('seller-content');
  c.innerHTML=`<div class='seller-header'><img src='${seller.avatar}'><h3>${seller.name}</h3><div>${seller.username}</div></div>
  <div class='seller-info'>📅 Дата регистрации: ${seller.registered}<br>💰 Объём торгов: ${seller.volume}<br>⭐ Общий рейтинг: ${seller.rating}</div>
  <div class='grid'>${itemsOf.map(renderSmallCard).join('')}</div>`;
  document.getElementById('seller-sheet').classList.add('show');
}
function closeSeller(){document.getElementById('seller-sheet').classList.remove('show')}

document.addEventListener('DOMContentLoaded',()=>{render();renderBalance();});
</script>
</body>
</html>
