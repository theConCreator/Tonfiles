<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tonfiles Market</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;font-family:Arial,Helvetica,sans-serif;
  background:#000;color:#fff;overflow-x:hidden;
}
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 20px;background:#111;border-bottom:2px solid #0eff00;
}
header img{height:28px;}
header .balance{display:flex;align-items:center;gap:6px;font-weight:bold;}
header .balance img{width:14px;height:14px;object-fit:contain;}

main{padding:15px 15px 80px;}

/* кнопки */
button,input[type=file],input[type=number],input[type=text],textarea,select{
  border-radius:6px;font-size:14px;transition:0.2s;
}
button{
  background:#0eff00;color:#000;border:none;padding:9px 10px;
  font-weight:bold;cursor:pointer;width:100%;
}
button:hover{opacity:0.9;}
button:focus{outline:none;box-shadow:0 0 6px #0eff00;}
button.dark{background:#111;border:1px solid #0eff00;color:#0eff00;}
button.dark:hover{background:#0eff00;color:#000;}

/* input */
input,textarea,select{
  background:#111;border:1px solid #0eff00;color:#fff;padding:8px;width:100%;
}
input:focus,textarea:focus,select:focus{outline:none;box-shadow:0 0 6px #0eff00;}

/* нижнее меню */
.tabs{
  display:flex;justify-content:space-around;position:fixed;bottom:0;left:0;width:100%;
  background:#111;border-top:2px solid #0eff00;
}
.tabs button{flex:1;background:none;border:none;color:#fff;padding:10px;cursor:pointer;}
.tabs button.active{color:#0eff00;font-weight:bold;}

/* разделы */
.section{display:none;}
.section.active{display:block;}

/* фильтры и поиск */
.search-filter{margin-bottom:15px;}
.search-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.search-row input{flex:1;min-width:120px;}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;}
.custom-select{position:relative;flex:1;min-width:150px;}
.custom-select button{
  background:#111;border:1px solid #0eff00;color:#fff;width:100%;
  text-align:left;padding:8px;border-radius:5px;
}
.custom-select button:after{content:"▼";float:right;color:#0eff00;}
.custom-options{
  display:none;position:absolute;top:38px;left:0;width:100%;background:#111;
  border:1px solid #0eff00;border-radius:5px;z-index:50;
}
.custom-options div{padding:8px;cursor:pointer;}
.custom-options div:hover{background:#0eff00;color:#000;}
.custom-select.open .custom-options{display:block;}

/* карточки */
.grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;
}
.card{
  background:#111;border:1px solid #0eff00;border-radius:8px;
  overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;
  position:relative;height:280px;
}
.card img{width:100%;height:160px;object-fit:cover;display:block;}
.card-content{padding:8px;flex-grow:1;}
.card-content h3{font-size:16px;margin:4px 0;}
.card-content p{font-size:13px;margin:2px 0;color:#ccc;}
.card .info-line{
  display:flex;justify-content:space-between;align-items:center;
  font-size:13px;margin-top:4px;color:#aaa;
}
.card button{margin-top:6px;}
.card-id{
  position:absolute;top:5px;right:7px;font-size:12px;color:#0eff00;opacity:0.8;
}

/* модалка */
.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:1000;
}
.modal.active{display:flex;}
.modal-content{
  background:#111;border:1px solid #0eff00;border-radius:10px;
  max-width:400px;width:90%;padding:15px;text-align:center;position:relative;
}
.modal-content img{width:100%;max-height:200px;object-fit:cover;border-radius:5px;margin-bottom:10px;}
.modal-content button{margin-top:8px;}
.modal-header{font-weight:bold;margin-bottom:5px;}
.modal-rating{color:#0eff00;margin-bottom:8px;font-size:14px;}
.modal-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.modal-buttons button{flex:1;}

/* публикация */
#add{max-width:420px;margin:0 auto;}
#add h2{text-align:center;}
#add .form-group{margin-bottom:12px;}
#add label{display:block;margin-bottom:4px;color:#0eff00;font-size:13px;}
.price-info{font-size:13px;color:#777;margin-top:5px;}

/* профиль */
#profile h2{text-align:center;}
.profile-box{
  padding:10px;background:#111;border:1px solid #0eff00;
  border-radius:8px;margin-bottom:15px;
}
.profile-tabs{display:flex;justify-content:center;border-bottom:1px solid #0eff00;margin-bottom:10px;}
.profile-tabs button{flex:1;background:none;border:none;color:#fff;padding:8px;cursor:pointer;}
.profile-tabs button.active{color:#0eff00;font-weight:bold;}
.profile-search{margin-bottom:10px;}
.profile-section{display:none;}
.profile-section.active{display:block;}

/* уведомления */
.toast{
  position:fixed;bottom:70px;right:20px;background:#111;border:1px solid #0eff00;
  padding:10px 15px;border-radius:5px;opacity:0;transition:opacity 0.5s;z-index:1000;
}
.toast.show{opacity:1;}
</style>
</head>
<body>
<header>
  <img src="tonfiles.svg" alt="logo">
  <div class="balance"><span id="balance">1000.00</span><img src="ton1.svg" alt="ton"></div>
</header>

<main>
  <!-- Главная -->
  <section id="home" class="section active">
    <div class="search-filter">
      <div class="search-row">
        <input id="search-input" placeholder="Поиск...">
        <button id="apply-btn">Применить</button>
      </div>
      <div class="filter-row">
        <input id="min-price" type="number" step="0.01" placeholder="Мин. цена">
        <input id="max-price" type="number" step="0.01" placeholder="Макс. цена">
        <div class="custom-select" id="sort-select">
          <button id="sort-btn">Последние</button>
          <div class="custom-options">
            <div data-val="newest">Последние</div>
            <div data-val="price_asc">Цена: по возрастанию</div>
            <div data-val="price_desc">Цена: по убыванию</div>
            <div data-val="best">Отзывы: лучшие</div>
            <div data-val="count">Отзывы: количество</div>
          </div>
        </div>
      </div>
    </div>
    <div class="grid" id="market-grid"></div>
  </section>

  <!-- Добавить -->
  <section id="add" class="section">
    <h2>Публикация объявления</h2>
    <div class="form-group"><label>Название</label><input id="add-name"></div>
    <div class="form-group"><label>Описание</label><textarea id="add-desc"></textarea></div>
    <div class="form-group"><label>Цена (TON)</label><input id="add-price" type="number" step="0.01"></div>
    <div class="price-info" id="price-info"></div>
    <div class="form-group"><label>Изображение</label><input id="add-preview" type="file" accept="image/*"></div>
    <div class="form-group"><label>Файл</label><input id="add-file" type="file"></div>
    <button onclick="publish()">Опубликовать</button>
  </section>

  <!-- Профиль -->
  <section id="profile" class="section">
    <h2>Профиль</h2>
    <div class="profile-box">
      <h3>Реферальная система</h3>
      <p>Баланс: <span id="ref-balance">0.00</span> <img src="ton1.svg" alt="ton" style="width:12px;height:12px;vertical-align:middle"></p>
      <p style="color:#777;font-size:13px;">2% от трат рефералов</p>
      <button onclick="withdrawRef()">Вывести</button>
    </div>

    <div class="profile-tabs">
      <button class="active" onclick="switchProfileTab('purchases')">Мои покупки</button>
      <button onclick="switchProfileTab('myitems')">Мои товары</button>
    </div>

    <div id="purchases" class="profile-section active">
      <div class="profile-search"><input id="purchases-search" placeholder="Поиск покупок..."></div>
      <div id="purchases-grid" class="grid"></div>
      <p id="purchases-empty" style="text-align:center;color:#777;">Пусто</p>
    </div>

    <div id="myitems" class="profile-section">
      <div class="profile-search"><input id="myitems-search" placeholder="Поиск товаров..."></div>
      <div id="myitems-grid" class="grid"></div>
      <p id="myitems-empty" style="text-align:center;color:#777;">Пусто</p>
    </div>
  </section>
</main>

<!-- нижнее меню -->
<div class="tabs">
  <button class="active" onclick="switchTab('home',this)">Главная</button>
  <button onclick="switchTab('add',this)">Добавить</button>
  <button onclick="switchTab('profile',this)">Профиль</button>
</div>

<!-- модалка товара -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modal-name"></h3>
    <img id="modal-img">
    <p id="modal-desc"></p>
    <p class="modal-rating" id="modal-rating"></p>
    <div class="modal-buttons" id="modal-buttons"></div>
    <button onclick="closeModal()">Закрыть</button>
  </div>
</div>

<!-- уведомление -->
<div class="toast" id="toast"></div>

<script>
let balance=1000,refBalance=0,userId=1;
let purchases=[],myItems=[],ratedItems=[];
let sort="newest";
const tonIcon='<img src="ton1.svg" style="width:12px;vertical-align:middle;">';

let items=[
  {id:12345,name:"React шаблон",desc:"Современный лендинг",price:20,img:"https://via.placeholder.com/300x200?text=React",file:"react.zip",ownerId:2,reviews:[5,4]},
  {id:22342,name:"Python бот",desc:"Telegram бот",price:12,img:"https://via.placeholder.com/300x200?text=Bot",file:"bot.zip",ownerId:3,reviews:[5,5,5]},
  {id:34564,name:"UI Курс",desc:"Основы дизайна",price:8,img:"https://via.placeholder.com/300x200?text=UI",file:"ui.mp4",ownerId:4,reviews:[4]},
];

function switchTab(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}
function switchProfileTab(id){
  document.querySelectorAll('.profile-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.profile-tabs button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  render();
}

document.getElementById('add-price').addEventListener('input',()=>{
  let val=parseFloat(addPrice.value);
  let info=document.getElementById('price-info');
  if(!val){info.innerHTML='';return;}
  if(val<0.1){
    addPrice.style.borderColor='red';
    info.style.color='red';
    info.innerHTML=`Минимальная сумма: 0.1 ${tonIcon}`;
  } else {
    addPrice.style.borderColor='#0eff00';
    info.style.color='#777';
    info.innerHTML=`Вы получите ${(val*0.9).toFixed(2)} ${tonIcon} с учётом комиссии (10%)`;
  }
});

function publish(){
  let name=addName.value.trim();
  let desc=addDesc.value.trim();
  let price=parseFloat(addPrice.value)||0;
  let imgFile=addPreview.files[0];
  let file=addFile.files[0];
  if(!name||!desc||!price||!imgFile||!file){showToast("Заполните все поля");return;}
  if(price<0.1){showToast("Минимальная цена 0.1 TON");return;}
  let reader=new FileReader();
  reader.onload=e=>{
    let newId=Math.floor(Math.random()*999999);
    let item={id:newId,name,desc,price,img:e.target.result,file:file.name,ownerId:userId,reviews:[]};
    items.unshift(item);myItems.push(item);
    showToast("Товар опубликован");
    addName.value=addDesc.value=addPrice.value="";addPreview.value=addFile.value="";
    document.getElementById('price-info').innerHTML="";
    render();
  };
  reader.readAsDataURL(imgFile);
}

function openModal(item){
  modalName.innerText=item.name;
  modalImg.src=item.img;
  modalDesc.innerText=item.desc;
  let avg=item.reviews.length?item.reviews.reduce((a,b)=>a+b)/item.reviews.length:0;
  modalRating.innerHTML=`⭐ ${avg.toFixed(1)} • ${item.price.toFixed(2)} ${tonIcon}`;
  let btns=document.getElementById('modal-buttons');
  btns.innerHTML="";
  if(item.ownerId===userId){
    btns.innerHTML=`<button class="dark">Мой товар</button><button style="background:red;" onclick="confirmDelete(${item.id})">Удалить</button>`;
  } else if(purchases.includes(item.id)){
    btns.innerHTML=`<button class="dark">Приобретено</button><button class="dark">Получить файл</button>`;
  } else {
    btns.innerHTML=`<button onclick='buy(${item.id})'>Купить за ${item.price.toFixed(2)} ${tonIcon}</button>`;
  }
  modal.classList.add('active');
}

function closeModal(){modal.classList.remove('active');}
function confirmDelete(id){
  if(confirm("Вы уверены, что хотите удалить товар? Отзывы будут утеряны.")){
    items=items.filter(i=>i.id!==id);
    myItems=myItems.filter(i=>i.id!==id);
    showToast("Товар удалён");
    closeModal();render();
  }
}

function buy(id){
  let item=items.find(i=>i.id===id);
  if(balance<item.price){showToast("Недостаточно средств");return;}
  balance-=item.price;refBalance+=item.price*0.02;purchases.push(id);
  showToast("Покупка успешна");closeModal();render();
}

function withdrawRef(){
  if(refBalance<=0){showToast("Недостаточно средств на реф. балансе");return;}
  balance+=refBalance;refBalance=0;showToast("Вывод успешен");render();
}

function showToast(m){
  let t=document.getElementById('toast');
  t.innerText=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function render(){
  balanceEl.innerText=balance.toFixed(2);
  refBalanceEl.innerText=refBalance.toFixed(2);
  let s=document.getElementById('search-input').value.toLowerCase();
  let min=parseFloat(minPrice.value)||0;
  let max=parseFloat(maxPrice.value)||Infinity;
  let list=items.filter(i=>(i.name+i.desc).toLowerCase().includes(s)&&i.price>=min&&i.price<=max);

  if(sort=="price_asc")list.sort((a,b)=>a.price-b.price);
  else if(sort=="price_desc")list.sort((a,b)=>b.price-a.price);
  else if(sort=="best")list.sort((a,b)=>b.reviews.length-a.reviews.length);
  else list.sort((a,b)=>b.id-a.id);

  let grid=document.getElementById('market-grid');
  grid.innerHTML=list.map(i=>{
    let avg=i.reviews.length?i.reviews.reduce((a,b)=>a+b)/i.reviews.length:0;
    let isMine=i.ownerId===userId;
    let isBought=purchases.includes(i.id);
    let btn=isMine?`<button class="dark" onclick="openModal(${JSON.stringify(i).replace(/"/g,'&quot;')})">Мой товар</button>
                   <button style='background:red;' onclick='confirmDelete(${i.id})'>Удалить</button>`
      :isBought?`<button class="dark" onclick="openModal(${JSON.stringify(i).replace(/"/g,'&quot;')})">Приобретено</button>
                 <button class="dark">Получить файл</button>`
      :`<button onclick="openModal(${JSON.stringify(i).replace(/"/g,'&quot;')})">Купить за ${i.price.toFixed(2)} ${tonIcon}</button>`;
    return `<div class='card'>
      <span class='card-id'>#${String(i.id).padStart(5,'0')}</span>
      <img src='${i.img}' onload='this.style.opacity=1'>
      <div class='card-content'>
        <h3>${i.name}</h3>
        <p>${i.desc}</p>
        <div class='info-line'><span>⭐ ${avg.toFixed(1)}</span><span>${i.price.toFixed(2)} ${tonIcon}</span></div>
        ${btn}
      </div>
    </div>`;
  }).join("");
  if(!list.length)grid.innerHTML="<p style='text-align:center;color:#777;'>Пусто</p>";

  // профиль
  renderProfile();
}

function renderProfile(){
  let purGrid=document.getElementById('purchases-grid');
  let myGrid=document.getElementById('myitems-grid');
  let purSearch=document.getElementById('purchases-search').value.toLowerCase();
  let mySearch=document.getElementById('myitems-search').value.toLowerCase();

  let purItems=items.filter(i=>purchases.includes(i.id)&&(i.name+i.desc).toLowerCase().includes(purSearch));
  let myItemsList=items.filter(i=>i.ownerId===userId&&(i.name+i.desc).toLowerCase().includes(mySearch));

  purGrid.innerHTML=purItems.map(i=>
    `<div class='card'><span class='card-id'>#${String(i.id).padStart(5,'0')}</span>
    <img src='${i.img}'><div class='card-content'><h3>${i.name}</h3>
    <p>${i.desc}</p><div class='info-line'><span>⭐ 5.0</span><span>${i.price.toFixed(2)} ${tonIcon}</span></div>
    <button class='dark' onclick='openModal(${JSON.stringify(i).replace(/"/g,'&quot;')})'>Приобретено</button>
    <button class='dark'>Получить файл</button></div></div>`).join("");

  myGrid.innerHTML=myItemsList.map(i=>
    `<div class='card'><span class='card-id'>#${String(i.id).padStart(5,'0')}</span>
    <img src='${i.img}'><div class='card-content'><h3>${i.name}</h3>
    <p>${i.desc}</p><div class='info-line'><span>⭐ 5.0</span><span>${i.price.toFixed(2)} ${tonIcon}</span></div>
    <button class='dark' onclick='openModal(${JSON.stringify(i).replace(/"/g,'&quot;')})'>Мой товар</button>
    <button style='background:red;' onclick='confirmDelete(${i.id})'>Удалить</button></div></div>`).join("");

  document.getElementById('purchases-empty').style.display=purItems.length?'none':'block';
  document.getElementById('myitems-empty').style.display=myItemsList.length?'none':'block';
}

document.getElementById('apply-btn').onclick=render;
document.querySelectorAll('.custom-options div').forEach(opt=>{
  opt.onclick=()=>{
    sort=opt.dataset.val;document.getElementById('sort-btn').innerText=opt.innerText;
    document.getElementById('sort-select').classList.remove('open');
    render();
  };
});
document.getElementById('sort-btn').onclick=()=>document.getElementById('sort-select').classList.toggle('open');
render();
</script>
</body>
</html>
