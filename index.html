<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TonFiles Market ‚Äî Demo</title>
<style>
/* ========== –ë–∞–∑–æ–≤—ã–µ ========== */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:#000;color:#fff;-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{color:inherit;text-decoration:none}

/* ========== –¶–≤–µ—Ç–∞ ========== */
:root{
  --accent:#36ff12;
  --bg:#0a0a0a;
  --card:#0a0a0a;
  --muted:#9fbf9f;
  --text-muted:#aeb7c9;
}

/* ========== –•–µ–¥–µ—Ä ========== */
header{
  position:sticky;top:0;z-index:120;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;background:var(--bg);border-bottom:2px solid var(--accent);
}
header img.logo{height:28px}
header .balance{display:flex;gap:8px;align-items:center;font-weight:700}
header .balance img.ton-icon{height:1em;vertical-align:middle;width:auto}

/* ========== –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ========== */
main{max-width:1200px;margin:0 auto;padding:16px 14px 100px}

/* ========== –¢–∞–±—ã –≤–Ω–∏–∑—É ========== */
.tabs{
  position:fixed;left:0;right:0;bottom:0;z-index:200;
  display:flex;background:var(--bg);border-top:2px solid var(--accent);
}
.tabs button{
  flex:1;padding:12px;border:0;background:none;color:#9aa;font-weight:700;cursor:pointer;
}
.tabs button.active{color:var(--accent)}

/* ========== –°–µ–∫—Ü–∏–∏ ========== */
.section{display:none}
.section.active{display:block}

/* ========== –ü–æ–∏—Å–∫ / —Ñ–∏–ª—å—Ç—Ä—ã ========== */
.search-filter{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.search-filter input,.search-filter select,.search-filter button{
  background:var(--bg);border:1px solid var(--accent);padding:8px;border-radius:8px;color:#fff;
}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.filter-row input{flex:1;min-width:110px}
.select-compact{min-width:140px}
.small-input{max-width:110px}

/* –∑–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è */
.apply-btn{background:var(--accent);color:#000;font-weight:700;cursor:pointer;border-radius:8px;padding:8px 12px;border:0}
.apply-btn:hover{filter:brightness(1.05)}

/* ========== –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ ========== */
.grid{
  display:grid;gap:14px;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
}

/* ========== –ö–∞—Ä—Ç–æ—á–∫–∞ ========== */
.card{
  background:var(--card);border:1px solid var(--accent);border-radius:12px;
  overflow:hidden;display:flex;flex-direction:column;cursor:pointer;
  transition:transform .16s,box-shadow .16s;height:320px;
}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(54,255,18,0.06)}
.image-wrap{height:160px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden}
.image-wrap img{width:100%;height:100%;object-fit:cover;display:block}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px;position:relative;flex:1}
.item-id{position:absolute;right:10px;top:8px;font-size:12px;color:#6b6f73}
.title{font-size:15px;font-weight:700;margin:0;line-height:1.2;overflow:hidden}
.desc{font-size:13px;color:#bfc7d9;margin:0;line-height:1.2;max-height:2.4em;overflow:hidden}
.row-info{display:flex;justify-content:space-between;align-items:center;color:var(--text-muted);font-size:13px;margin-top:auto}
.row-info img.ton-icon{height:1em;width:auto;vertical-align:middle}
.btn-row{display:flex;gap:8px;margin-top:10px}
.btn{
  flex:1;padding:8px;border-radius:8px;border:0;font-weight:700;cursor:pointer;
  display:inline-flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap;
}
.btn-primary{background:var(--accent);color:#000}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe}

/* —É–¥–∞–ª–∏—Ç—å ‚Äî —Ç–æ–Ω–∫–∞—è –∫—Ä–∞—Å–Ω–∞—è */
.btn-danger{background:transparent;border:1px solid #ff5c5c;color:#ff9b9b}

/* —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–Ω–æ–ø–∫–∏ –¥–æ –Ω–∏–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ–º margin-top:auto —É row-info –∏ btn-row —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –≤–Ω–∏–∑—É */
/* (card-body already flex:1; row-info margin-top:auto helps pin) */

/* ========== –ú–æ–¥–∞–ª ========== */
.modal{
  position:fixed;left:0;top:0;right:0;bottom:0;display:none;
  justify-content:center;align-items:center;background:rgba(0,0,0,0.8);z-index:400;
}
.modal.show{display:flex}
.modal-card{
  background:var(--bg);border:1px solid var(--accent);border-radius:12px;padding:16px;
  width:95%;max-width:520px;max-height:90%;overflow:auto;position:relative;
  animation:modalIn .28s ease;
}
@keyframes modalIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.modal-card img{width:100%;max-height:260px;object-fit:cover;border-radius:8px;margin-bottom:10px}
.modal-title{font-size:18px;margin:0 0 8px}
.modal-desc{color:#bfc7d9;margin:0 0 10px}
.modal-line{display:flex;justify-content:center;align-items:center;gap:8px;color:#dfe6f9;font-weight:700;margin-bottom:10px}
.modal-line img.ton-icon{height:1em;width:auto}
.modal-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.stars{font-size:22px;margin:10px 0;display:flex;gap:6px;justify-content:center}
.star{cursor:pointer;color:#555;user-select:none}
.star.active{color:var(--accent)}
.modal-close{position:absolute;right:10px;top:10px;background:none;border:0;color:#999;font-size:22px;cursor:pointer}
.modal-close:hover{color:var(--accent)}

/* ========== –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ========== */
#add form{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:10px}
label{color:var(--accent);font-weight:700;font-size:13px}
input[type="text"],input[type="number"],textarea{
  background:var(--bg);border:1px solid var(--accent);padding:10px;border-radius:8px;color:#fff;font-size:14px
}
textarea{min-height:90px;resize:vertical}
#commission-info{color:var(--muted);font-size:13px}
#commission-info.error{color:#ff5c5c}
#add button[type=submit]{background:var(--accent);color:#000;font-weight:700;border:0;border-radius:8px;padding:10px;cursor:pointer}
#add button[type=submit]:hover{filter:brightness(1.05)}
.input-error{border-color:#ff5c5c !important}

/* ========== –ü—Ä–æ—Ñ–∏–ª—å ========== */
.profile-box{background:var(--bg);border:1px solid var(--accent);padding:12px;border-radius:10px;margin-bottom:12px}
.profile-tabs{display:flex;border-bottom:1px solid var(--accent);margin-bottom:10px}
.profile-tabs button{flex:1;background:none;border:0;color:#dfe;padding:8px;font-weight:700;cursor:pointer}
.profile-tabs button.active{color:var(--accent)}
.profile-search input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--accent);background:var(--bg);color:#fff}

/* ========== Seller sheet (–≤—ã–µ–∑–∂–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å) ========== */
.seller-sheet{
  position:fixed;left:0;right:0;bottom:-110%;z-index:500;
  background:var(--bg);border-top:2px solid var(--accent);border-radius:16px 16px 0 0;
  box-shadow:0 -10px 40px rgba(0,0,0,.6);transition:bottom .38s cubic-bezier(.2,.9,.2,1);
  max-height:92%;overflow-y:auto;padding:14px;
}
.seller-sheet.show{bottom:0}
.seller-header{text-align:center;margin-bottom:12px;position:relative}
.seller-header img{width:96px;height:96px;border-radius:50%;border:2px solid var(--accent);object-fit:cover}
.seller-header h3{margin:8px 0 4px}
.seller-info{font-size:13px;color:var(--text-muted);margin-bottom:8px}
.seller-close{position:absolute;right:10px;top:8px;background:none;border:0;font-size:22px;color:#999;cursor:pointer}
.seller-close:hover{color:var(--accent)}

/* ========== Toast ========== */
.toast{position:fixed;right:18px;bottom:84px;background:var(--accent);color:#000;border-radius:8px;padding:10px 14px;opacity:0;transition:opacity .25s;z-index:1000}
.toast.show{opacity:1}

/* –£–±—Ä–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ñ–æ–∫—É—Å—ã */
button,input,textarea{outline:none}
</style>
</head>
<body>

<header>
  <img class="logo" src="tonfiles.svg" alt="TONFiles">
  <div class="balance"><span id="balance">1000.00</span> <img src="ton1.svg" class="ton-icon" alt="TON"></div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="section active">
    <div class="search-filter">
      <input id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é...">
      <div class="filter-row">
        <input id="min-price" type="number" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" step="0.01" class="small-input">
        <input id="max-price" type="number" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" step="0.01" class="small-input">
        <input id="id-search" type="number" placeholder="ID —Ç–æ–≤–∞—Ä–∞" class="small-input">
      </div>
      <div class="filter-row">
        <select id="sort-select" class="select-compact">
          <option value="latest">–ü–æ—Å–ª–µ–¥–Ω–∏–µ</option>
          <option value="price-asc">–¶–µ–Ω–∞ ‚Üë</option>
          <option value="price-desc">–¶–µ–Ω–∞ ‚Üì</option>
          <option value="best">–û—Ç–∑—ã–≤—ã: –ª—É—á—à–∏–µ</option>
        </select>
        <button class="apply-btn" onclick="render()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div id="market-grid" class="grid"></div>
    <p id="market-empty" style="text-align:center;color:var(--muted);display:none;margin-top:10px">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</p>
  </section>

  <!-- ADD -->
  <section id="add" class="section">
    <form onsubmit="event.preventDefault();publish();">
      <label for="add-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="add-name" type="text" />
      <label for="add-desc">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="add-desc"></textarea>
      <label for="add-price">–¶–µ–Ω–∞ (TON)</label><input id="add-price" type="number" step="0.01" oninput="updateCommission()" />
      <div id="commission-info">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: 0.00 TON (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 10%)</div>
      <label for="add-preview">–ü—Ä–µ–≤—å—é (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</label><input id="add-preview" type="file" accept="image/*" />
      <label for="add-file">–§–∞–π–ª</label><input id="add-file" type="file" />
      <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="section">
    <div class="profile-box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div>
          <div style="font-size:13px;color:var(--muted)">2% –æ—Ç —Ç—Ä–∞—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800"><span id="ref-balance">0.00</span> <img src="ton1.svg" class="ton-icon" alt="TON"></div>
          <button class="btn btn-primary" style="font-size:12px;padding:6px 8px;margin-top:6px" onclick="withdrawRef()">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
      </div>
    </div>

    <div class="profile-tabs">
      <button class="active" onclick="switchProfileTab('purchases', this)">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</button>
      <button onclick="switchProfileTab('myitems', this)">–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</button>
    </div>

    <div class="profile-search"><input id="profile-search" placeholder="–ü–æ–∏—Å–∫..." oninput="render()" /></div>

    <div id="purchases" class="profile-section active">
      <div id="purchases-grid" class="grid"></div>
      <p id="purchases-empty" style="text-align:center;color:var(--muted);display:none;margin-top:8px">–ü—É—Å—Ç–æ</p>
    </div>

    <div id="myitems" class="profile-section">
      <div id="myitems-grid" class="grid"></div>
      <p id="myitems-empty" style="text-align:center;color:var(--muted);display:none;margin-top:8px">–ü—É—Å—Ç–æ</p>
    </div>
  </section>
</main>

<!-- Bottom tabs -->
<div class="tabs">
  <button class="active" onclick="switchTab('home', this)">–ì–ª–∞–≤–Ω–∞—è</button>
  <button onclick="switchTab('add', this)">–î–æ–±–∞–≤–∏—Ç—å</button>
  <button onclick="switchTab('profile', this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<!-- Modal -->
<div id="modal" class="modal" onclick="if(event.target===this) closeModal()">
  <div id="modal-card" class="modal-card" role="dialog" aria-modal="true"></div>
</div>

<!-- Seller sheet -->
<div id="seller-sheet" class="seller-sheet" aria-hidden="true">
  <button class="seller-close" onclick="closeSeller()">√ó</button>
  <div id="seller-content"></div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ========== Demo state ========== */
let balance = 1000.00;
let refBalance = 0.00;
const userId = 1; // —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å demo
let purchases = [];      // –º–∞—Å—Å–∏–≤ id –∫—É–ø–ª–µ–Ω–Ω—ã—Ö
let myItems = [];        // –º–æ–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
let userRatings = {};    // userRatings[itemId] = rating (1..5)
let items = [
  { id: 101, name:"–°–∫—Ä–∏–ø—Ç Telegram Bot", desc:"–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π –±–æ—Ç", price:15, img:"https://via.placeholder.com/600x400?text=Bot", file:"bot.zip", ownerId:2, reviews:[5,4]},
  { id: 102, name:"–í–∏–¥–µ–æ—É—Ä–æ–∫ –ø–æ –¥–∏–∑–∞–π–Ω—É", desc:"–°–æ–≤–µ—Ç—ã –¥–ª—è UI/UX", price:8, img:"https://via.placeholder.com/600x400?text=Design", file:"design.mp4", ownerId:3, reviews:[5,5,4]},
  { id: 103, name:"NFT —à–∞–±–ª–æ–Ω", desc:"–®–∞–±–ª–æ–Ω NFT-–∫–æ–ª–ª–µ–∫—Ü–∏–∏", price:22, img:"https://via.placeholder.com/600x400?text=NFT", file:"nft.psd", ownerId:4, reviews:[4,3]},
  { id: 104, name:"React —Å–∞–π—Ç", desc:"–ö—Ä–∞—Å–∏–≤—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω", price:18, img:"https://via.placeholder.com/600x400?text=React", file:"site.zip", ownerId:5, reviews:[]}
];
// –¥–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–æ–π —Ç–æ–≤–∞—Ä
(function seed(){
  const it={ id:100, name:"–ú–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª", desc:"–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª", price:5, img:"https://via.placeholder.com/600x400?text=My+File", file:"test.zip", ownerId:userId, reviews:[5] };
  items.unshift(it);
  myItems.push(it);
})();

const MIN_PRICE = 0.1;

/* ========== Helpers ========== */
function toMoney(n){ return Number(n).toFixed(2); }
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1900);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function avgRating(arr){
  if(!arr || !arr.length) return 0;
  const sum = arr.reduce((a,b)=>a+b,0);
  return +(sum/arr.length).toFixed(1);
}
function prepareText(s,len){ return escapeHtml(s.length>len? s.slice(0,len)+'‚Ä¶' : s); }

/* ========== Commission (add form) ========== */
function updateCommission(){
  const p = document.getElementById('add-price');
  const info = document.getElementById('commission-info');
  const v = parseFloat(p.value) || 0;
  if(v < MIN_PRICE){
    p.classList.add('input-error');
    info.classList.add('error');
    info.classList.add('error-text');
    info.classList.add('error'); // for CSS selection
    // red text
    info.classList.add('error');
    info.innerHTML = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: ${MIN_PRICE.toFixed(2)} <img src="ton1.svg" class="ton-icon" alt="TON">`;
    info.style.color = '#ff5c5c';
  } else {
    p.classList.remove('input-error');
    info.style.color = '';
    info.innerHTML = `–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ${(v*0.9).toFixed(2)} TON (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 10%)`;
  }
}

/* ========== Publish item ========== */
function publish(){
  const n = document.getElementById('add-name');
  const d = document.getElementById('add-desc');
  const p = document.getElementById('add-price');
  const pr = document.getElementById('add-preview');
  const f = document.getElementById('add-file');

  if(!n.value.trim() || !d.value.trim() || !p.value || !pr.files[0] || !f.files[0]){
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  if(parseFloat(p.value) < MIN_PRICE){
    showToast(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ${MIN_PRICE.toFixed(2)} TON`);
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const id = Math.floor(Math.random()*900000) + 100000; // 6-digit approx
    const item = {
      id,
      name: n.value.trim(),
      desc: d.value.trim(),
      price: Number(parseFloat(p.value).toFixed(2)),
      img: e.target.result,
      file: f.files[0].name,
      ownerId: userId,
      reviews: []
    };
    items.unshift(item);
    myItems.push(item);

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    n.value=''; d.value=''; p.value=''; pr.value=''; f.value='';
    document.getElementById('commission-info').textContent = '–í—ã –ø–æ–ª—É—á–∏—Ç–µ: 0.00 TON (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 10%)';
    document.getElementById('commission-info').style.color='';
    showToast('–¢–æ–≤–∞—Ä –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω');
    render();
  };
  reader.readAsDataURL(pr.files[0]);
}

/* ========== Buy flow ========== */
function buyFromModal(id){
  const it = items.find(x=>x.id===id);
  if(!it){ showToast('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  if(it.ownerId === userId){ showToast('–≠—Ç–æ –≤–∞—à —Ç–æ–≤–∞—Ä'); return; }
  if(balance < it.price){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
  // —Å–ø–∏—Å–∞–Ω–∏–µ
  balance = +(balance - it.price).toFixed(2);
  refBalance = +(refBalance + it.price*0.02).toFixed(2);
  purchases.push(it.id);
  showToast('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞');
  renderBalance();
  // –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª: –ø–æ–∫–∞–∑–∞—Ç—å "–∫—É–ø–ª–µ–Ω–æ" —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  openModal(id, true);
  render(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ç–∫–∏
}

/* ========== Show file placeholder ========== */
function getFileFromModal(id){
  const it = items.find(x=>x.id===id);
  if(!it) return showToast('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
  // –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞: –ø–æ–∑–∂–µ –±–µ–∫–µ–Ω–¥ –¥–∞—Å—Ç —Å—Å—ã–ª–∫—É
  showToast(`–§–∞–π–ª "${it.file}" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥–∞`);
}

/* ========== Delete ========== */
function deleteItem(id){
  // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä? –†–µ–π—Ç–∏–Ω–≥ –±—É–¥–µ—Ç —É—Ç–µ—Ä—è–Ω –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.')) return;
  items = items.filter(x=>x.id !== id);
  myItems = myItems.filter(x=>x.id !== id);
  purchases = purchases.filter(pid => pid !== id);
  delete userRatings[id];
  showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
  render();
}

/* ========== Ratings logic ========== */
/* –ó–∞–ø–∏—Å—ã–≤–∞–µ–º/–º–µ–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É userRatings[itemId] */
function rateItem(id, value){
  // —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ
  if(!purchases.includes(id)) { showToast('–û—Ü–µ–Ω–∏–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏'); return; }
  const it = items.find(x=>x.id===id);
  if(!it) return;
  // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ —Å—Ç–∞–≤–∏–ª –æ—Ü–µ–Ω–∫—É (userRatings[id]), –º–µ–Ω—è–µ–º: —É–º–µ–Ω—å—à–∞–µ–º/—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º
  const prev = userRatings[id];
  if(prev){
    // –∑–∞–º–µ–Ω—è–µ–º –≤ reviews (—É–¥–∞–ª–∏–º –æ–¥–∏–Ω prev –∏ –¥–æ–±–∞–≤–∏–º value) ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–æ: –¥–æ–±–∞–≤–∏–º –Ω–æ–≤–æ–µ –∏ –æ—Å—Ç–∞–≤–∏–º —Å—Ç–∞—Ä–æ–µ: –¥–ª—è demo —É–¥–∞–ª–∏–º –æ–¥–Ω–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ prev
    const idx = it.reviews.indexOf(prev);
    if(idx !== -1) it.reviews.splice(idx,1);
  }
  it.reviews.push(value);
  userRatings[id] = value;
  showToast('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!');
  // –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª (–ø–æ–∫–∞–∂–µ–º –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã–µ –∑–≤–µ–∑–¥—ã)
  openModal(id, purchases.includes(id));
  render();
}

/* ========== Modal (item) ========== */
function openModal(id, bought=false){
  const it = items.find(x=>x.id===id);
  if(!it) return;
  const modal = document.getElementById('modal');
  const card = document.getElementById('modal-card');

  const avg = avgRating(it.reviews);
  const cnt = it.reviews.length;
  const owned = it.ownerId === userId;
  const isBought = purchases.includes(it.id) || bought;

  // actions area
  let actionsHtml = '';
  if(owned){
    actionsHtml = `<button class="btn btn-ghost" disabled>–ú–æ–π —Ç–æ–≤–∞—Ä</button>
                   <button class="btn btn-danger" onclick="deleteItem(${it.id}); closeModal()">–£–¥–∞–ª–∏—Ç—å</button>`;
  } else if(isBought){
    actionsHtml = `<button class="btn btn-ghost" disabled>–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ</button>
                   <button class="btn btn-ghost" onclick="getFileFromModal(${it.id})">–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª</button>`;
  } else {
    actionsHtml = `<button class="btn btn-primary" onclick="buyFromModal(${it.id})">–ö—É–ø–∏—Ç—å –∑–∞ ${it.price} <img src="ton1.svg" class="ton-icon" alt="TON"></button>`;
  }

  // stars (only show interactive stars if bought)
  let starsHtml = '';
  if(isBought){
    // build 5 stars, mark active by userRatings if exists else 0
    const ur = userRatings[it.id] || 0;
    starsHtml = '<div class="stars">';
    for(let i=1;i<=5;i++){
      starsHtml += `<span class="star ${ur>=i ? 'active' : ''}" onclick="rateItem(${it.id}, ${i})">‚òÖ</span>`;
    }
    starsHtml += '</div>';
    // show current user rating note (if any)
  }

  card.innerHTML = `
    <button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="closeModal()">√ó</button>
    <img src="${it.img}" alt="${escapeHtml(it.name)}">
    <h3 class="modal-title">${prepareText(it.name, 80)}</h3>
    <p class="modal-desc">${escapeHtml(it.desc)}</p>
    <div class="modal-line">${avg ? avg : '‚Äî'} (${cnt}) &nbsp; ‚Ä¢ &nbsp; <strong>${it.price} <img src="ton1.svg" class="ton-icon" alt="TON"></strong></div>
    <div class="modal-actions">${actionsHtml}</div>
    ${isBought ? starsHtml : ''}
  `;
  modal.classList.add('show');
}

/* close modal */
function closeModal(){ document.getElementById('modal').classList.remove('show'); }

/* ========== Render balance ========== */
function renderBalance(){
  document.getElementById('balance').textContent = toMoney(balance);
  document.getElementById('ref-balance').textContent = toMoney(refBalance);
}

/* ========== Seller sheet (profile) ========== */
/* –û—Ç–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ ID —Ç–æ–≤–∞—Ä–∞: openSeller(ownerId) */
function openSeller(ownerId){
  // —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–≤—Ü–∞ (–ø–æ–∫–∞ –±–µ–∑ –±–µ–∫–µ–Ω–¥–∞)
  const seller = {
    id: ownerId,
    username: '@user' + ownerId,
    name: '–ü—Ä–æ–¥–∞–≤–µ—Ü ' + ownerId,
    registered: '2024-05-12',
    volume: (Math.floor(Math.random()*200)+5) + ' TON',
    avatar: 'https://via.placeholder.com/160?text=User+' + ownerId
  };
  // –≤—ã—á–∏—Å–ª–∏–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞–≤—Ü–∞
  const sellerItems = items.filter(i=>i.ownerId === ownerId);

  const container = document.getElementById('seller-content');
  container.innerHTML = `
    <div class="seller-header">
      <img src="${seller.avatar}" alt="${escapeHtml(seller.name)}">
      <h3>${escapeHtml(seller.name)}</h3>
      <div style="color:var(--text-muted)">${escapeHtml(seller.username)}</div>
    </div>
    <div class="seller-info">
      üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${seller.registered}<br>
      üí∞ –û–±—ä—ë–º —Ç–æ—Ä–≥–æ–≤: ${seller.volume}<br>
      ‚≠ê –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ${computeSellerRating(sellerItems)}
    </div>
    <div style="margin-bottom:12px;font-weight:700">–¢–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞–≤—Ü–∞</div>
    <div class="grid">
      ${sellerItems.map(i=>smallCardHtml(i)).join('')}
    </div>
  `;
  document.getElementById('seller-sheet').classList.add('show');
}
function closeSeller(){ document.getElementById('seller-sheet').classList.remove('show'); }
function computeSellerRating(list){
  let all = [];
  list.forEach(i=>{
    if(i.reviews && i.reviews.length) all = all.concat(i.reviews);
  });
  if(!all.length) return '‚Äî';
  const avg = +(all.reduce((a,b)=>a+b,0)/all.length).toFixed(1);
  return `${avg} (${all.length})`;
}

/* ========== Small card HTML (for seller sheet and profile lists) ========== */
function smallCardHtml(i){
  const rating = i.reviews.length ? avgRating(i.reviews) : '‚Äî';
  const cnt = i.reviews.length;
  // buyer/owner buttons are handled when rendering inside profile; here just show clickable card
  return `<div class='card' onclick='openModal(${i.id}, ${purchases.includes(i.id)})'>
    <div class='image-wrap'><img src='${i.img}' alt='${escapeHtml(i.name)}'></div>
    <div class='card-body'>
      <span class='item-id' onclick='event.stopPropagation(); openSeller(${i.ownerId})'>#${String(i.id).padStart(5,'0')}</span>
      <div class='title'>${prepareText(i.name,40)}</div>
      <div class='desc'>${prepareText(i.desc,60)}</div>
      <div class='row-info'><span>${rating} (${cnt})</span><span>${i.price} <img src='ton1.svg' class='ton-icon' alt='TON'></span></div>
      <div class='btn-row'>${i.ownerId===userId ? `<button class='btn btn-ghost' onclick='event.stopPropagation(); openModal(${i.id}, ${purchases.includes(i.id)})'>–ú–æ–π —Ç–æ–≤–∞—Ä</button>
        <button class='btn btn-danger' onclick='event.stopPropagation(); deleteItem(${i.id})'>–£–¥–∞–ª–∏—Ç—å</button>` :
         purchases.includes(i.id) ? `<button class='btn btn-primary' onclick='event.stopPropagation(); openModal(${i.id}, true)'>–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ</button>
        <button class='btn btn-ghost' onclick='event.stopPropagation(); getFileFromModal(${i.id})'>–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª</button>` :
         `<button class='btn btn-primary' onclick='event.stopPropagation(); openModal(${i.id}, false)'>–ö—É–ø–∏—Ç—å –∑–∞ ${i.price} <img src='ton1.svg' class='ton-icon' alt='TON'></button>`}
      </div>
    </div>
  </div>`;
}

/* ========== Render main grids ========== */
function render(){
  renderBalance();

  // filters
  const s = (document.getElementById('search-input')?.value || '').toLowerCase().trim();
  const idVal = parseInt(document.getElementById('id-search')?.value) || null;
  const min = parseFloat(document.getElementById('min-price')?.value) || 0;
  const max = parseFloat(document.getElementById('max-price')?.value) || Infinity;
  const sort = document.getElementById('sort-select')?.value || 'latest';

  let list = items.filter(i=>{
    if(idVal && i.id !== idVal) return false;
    if(!(i.name + ' ' + i.desc).toLowerCase().includes(s)) return false;
    if(i.price < min || i.price > max) return false;
    return true;
  });

  if(sort === 'price-asc') list.sort((a,b)=>a.price-b.price);
  else if(sort === 'price-desc') list.sort((a,b)=>b.price-a.price);
  else if(sort === 'best') list.sort((a,b)=> (avgRating(b.reviews) - avgRating(a.reviews)));
  else list.sort((a,b)=> b.id - a.id); // latest default

  const grid = document.getElementById('market-grid');
  grid.innerHTML = list.map(i => {
    const rating = i.reviews.length ? avgRating(i.reviews) : '‚Äî';
    const cnt = i.reviews.length;
    const mine = i.ownerId === userId;
    const bought = purchases.includes(i.id);
    // buttons
    let btns = '';
    if(mine){
      btns = `<button class="btn btn-ghost" onclick="event.stopPropagation(); openModal(${i.id}, ${bought})">–ú–æ–π —Ç–æ–≤–∞—Ä</button>
              <button class="btn btn-danger" onclick="event.stopPropagation(); deleteItem(${i.id})">–£–¥–∞–ª–∏—Ç—å</button>`;
    } else if(bought){
      btns = `<button class="btn btn-primary" onclick="event.stopPropagation(); openModal(${i.id}, true)">–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ</button>
              <button class="btn btn-ghost" onclick="event.stopPropagation(); getFileFromModal(${i.id})">–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª</button>`;
    } else {
      btns = `<button class="btn btn-primary" onclick="event.stopPropagation(); openModal(${i.id}, false)">–ö—É–ø–∏—Ç—å –∑–∞ ${i.price} <img src="ton1.svg" class="ton-icon" alt="TON"></button>`;
    }
    // card HTML. item-id is clickable to open seller profile
    return `<div class="card" onclick="openModal(${i.id}, ${bought})" role="button" aria-pressed="false">
      <div class="image-wrap"><img src="${i.img}" alt="${escapeHtml(i.name)}"></div>
      <div class="card-body">
        <div class="item-id" onclick="event.stopPropagation(); openSeller(${i.ownerId})">#${String(i.id).padStart(5,'0')}</div>
        <div class="title">${prepareText(i.name,60)}</div>
        <div class="desc">${prepareText(i.desc,80)}</div>
        <div class="row-info"><span>‚òÖ ${rating} (${cnt})</span><span>${i.price} <img src="ton1.svg" class="ton-icon" alt="TON"></span></div>
        <div class="btn-row">${btns}</div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('market-empty').style.display = list.length ? 'none' : 'block';

  // profile lists
  renderProfile();
}

/* ========== Render profile sections ========== */
let currentProfileTab = 'purchases';
function switchProfileTab(id, btn){
  currentProfileTab = id;
  document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

function renderProfile(){
  const q = (document.getElementById('profile-search')?.value || '').toLowerCase().trim();

  // purchases
  const pgrid = document.getElementById('purchases-grid');
  const pList = purchases.map(id => items.find(it=>it.id===id)).filter(Boolean).filter(it => (it.name + it.desc).toLowerCase().includes(q));
  pgrid.innerHTML = pList.length ? pList.map(i=>smallCardHtml(i)).join('') : '';
  document.getElementById('purchases-empty').style.display = pList.length ? 'none' : 'block';

  // myitems
  const mgrid = document.getElementById('myitems-grid');
  const mList = myItems.filter(Boolean).filter(it => (it.name + it.desc).toLowerCase().includes(q));
  mgrid.innerHTML = mList.length ? mList.map(i=>smallCardHtml(i)).join('') : '';
  document.getElementById('myitems-empty').style.display = mList.length ? 'none' : 'block';
}

/* ========== Tabs (bottom) ========== */
function switchTab(id, btn){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

/* ========== Withdraw referral ========== */
function withdrawRef(){
  if(refBalance <= 0) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞'); return; }
  balance = +(balance + refBalance).toFixed(2);
  refBalance = 0;
  renderBalance();
  showToast('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –≤—ã–≤–µ–¥–µ–Ω');
}

/* ========== Init ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('commission-info').textContent = '–í—ã –ø–æ–ª—É—á–∏—Ç–µ: 0.00 TON (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 10%)';
  // Enter handlers for searches
  document.getElementById('search-input').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); render(); }});
  document.getElementById('profile-search').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); render(); }});
  render();
  renderBalance();
});
</script>
</body>
</html>
