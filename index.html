<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TonFiles Market</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;}
header{
  display:flex;justify-content:space-between;align-items:center;
  background:#111;padding:10px 20px;border-bottom:2px solid #0eff00;
}
header img{height:28px;}
header .balance{display:flex;align-items:center;gap:6px;font-weight:bold;}
header .balance img{width:14px;height:14px;object-fit:contain;}

main{padding:15px 15px 70px;}

/* Tabs */
.tabs{
  display:flex;justify-content:space-around;align-items:center;
  position:fixed;bottom:0;left:0;width:100%;
  background:#111;border-top:2px solid #0eff00;z-index:100;
}
.tabs button{
  flex:1;background:none;border:none;color:#fff;padding:10px;
  cursor:pointer;font-weight:bold;
}
.tabs button.active{color:#0eff00;}

/* Sections */
.section{display:none;}
.section.active{display:block;}

/* Search & Filter */
.search-filter{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
.search-filter input{
  flex:1;min-width:130px;padding:8px;border:1px solid #0eff00;
  border-radius:6px;background:#111;color:#fff;
}
.custom-select{position:relative;min-width:160px;flex:1;}
.custom-select button{
  width:100%;background:#111;border:1px solid #0eff00;
  color:#fff;text-align:left;padding:8px;border-radius:6px;
}
.custom-select button:after{content:"▼";float:right;color:#0eff00;}
.custom-options{
  display:none;position:absolute;top:38px;left:0;width:100%;
  background:#111;border:1px solid #0eff00;border-radius:6px;z-index:20;
}
.custom-options div{padding:8px;cursor:pointer;}
.custom-options div:hover{background:#0eff00;color:#000;}
.custom-select.open .custom-options{display:block;}
button{cursor:pointer;border:none;}

/* Cards */
.grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:15px;
}
.card{
  background:#111;border:1px solid #0eff00;border-radius:8px;
  overflow:hidden;display:flex;flex-direction:column;
  justify-content:space-between;transition:transform .2s;
  height:280px;
}
.card:hover{transform:translateY(-2px);}
.card img{
  width:100%;height:160px;object-fit:cover;display:block;
  background:#111;
}
.card-content{padding:8px;position:relative;flex-grow:1;}
.card-content h3{font-size:16px;margin:4px 0;}
.card-content p{font-size:13px;color:#ccc;margin:3px 0;}
.card .info-line{
  display:flex;justify-content:space-between;align-items:center;
  font-size:13px;color:#aaa;margin-top:6px;
}
.card .info-line img{width:12px;height:12px;vertical-align:middle;}
.card .item-id{
  position:absolute;top:6px;right:8px;font-size:11px;color:#888;
}
.card button{
  background:#0eff00;color:#000;font-weight:bold;
  border:none;border-radius:6px;padding:8px;margin-top:8px;width:100%;
}
.card button img{
  width:12px;height:12px;vertical-align:middle;margin-left:4px;
}
.card button:hover{opacity:0.9;}

/* Modal */
.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.85);display:none;
  justify-content:center;align-items:center;z-index:1000;
}
.modal.active{display:flex;}
.modal-content{
  background:#111;border:1px solid #0eff00;border-radius:10px;
  padding:15px;max-width:400px;width:90%;text-align:center;
}
.modal-content img{
  width:100%;max-height:200px;object-fit:cover;
  border-radius:6px;margin-bottom:10px;
}
.modal-content button{
  margin-top:6px;width:100%;border-radius:6px;padding:8px;
}
.modal-content img.icon{width:12px;height:12px;vertical-align:middle;margin-left:4px;}

/* Add section */
#add{max-width:420px;margin:0 auto;}
#add h2{text-align:center;}
#add .form-group{margin-bottom:12px;}
#add label{display:block;margin-bottom:4px;color:#0eff00;font-size:13px;}
#add input,#add textarea{
  background:#111;border:1px solid #0eff00;color:#fff;
  border-radius:6px;padding:8px;width:100%;font-size:14px;
}

/* Profile */
#profile h2{text-align:center;}
.profile-box{
  padding:10px;background:#111;border:1px solid #0eff00;
  border-radius:8px;margin-bottom:15px;
}
.profile-tabs{
  display:flex;justify-content:center;border-bottom:1px solid #0eff00;
  margin-bottom:10px;
}
.profile-tabs button{
  flex:1;background:none;border:none;color:#fff;padding:8px;
}
.profile-tabs button.active{color:#0eff00;font-weight:bold;}
.profile-search{margin-bottom:10px;}

/* Stars */
.stars{font-size:22px;margin:8px 0;}
.star{cursor:pointer;color:#555;}
.star.active{color:#0eff00;}

/* Toast */
.toast{
  position:fixed;bottom:70px;right:20px;background:#111;
  border:1px solid #0eff00;padding:10px 15px;border-radius:5px;
  opacity:0;transition:opacity 1s;z-index:1000;
}
.toast.show{opacity:1;transition:opacity 0.5s;}
</style>
</head>
<body>
<header>
  <img src="tonfiles.svg" alt="logo">
  <div class="balance"><span id="balance">1000.00</span><img src="ton1.svg" alt="ton"></div>
</header>

<main>
  <!-- Главная -->
  <section id="home" class="section active">
    <div class="search-filter">
      <input id="search-input" placeholder="Поиск...">
      <div style="display:flex;gap:10px;width:100%;">
        <input id="min-price" type="number" placeholder="Мин. цена">
        <input id="max-price" type="number" placeholder="Макс. цена">
      </div>
      <div class="custom-select" id="sort-select">
        <button id="sort-btn">Последние</button>
        <div class="custom-options">
          <div data-val="newest">Последние</div>
          <div data-val="price_asc">Цена ↑</div>
          <div data-val="price_desc">Цена ↓</div>
          <div data-val="best">Отзывы: лучшие</div>
          <div data-val="count">Отзывы: количество</div>
        </div>
      </div>
      <button onclick="render()">Применить</button>
    </div>
    <div class="grid" id="market-grid"></div>
  </section>

  <!-- Добавить -->
  <section id="add" class="section">
    <h2>Публикация объявления</h2>
    <div class="form-group"><label>Название</label><input id="add-name"></div>
    <div class="form-group"><label>Описание</label><textarea id="add-desc"></textarea></div>
    <div class="form-group"><label>Цена (TON)</label><input id="add-price" type="number" step="0.01"></div>
    <div class="form-group"><label>Изображение</label><input id="add-preview" type="file" accept="image/*"></div>
    <div class="form-group"><label>Файл</label><input id="add-file" type="file"></div>
    <button onclick="publish()">Опубликовать</button>
  </section>

  <!-- Профиль -->
  <section id="profile" class="section">
    <h2>Профиль</h2>
    <div class="profile-box">
      <h3>Реферальная система</h3>
      <p>Баланс: <span id="ref-balance">0.00</span> <img src="ton1.svg" style="width:12px;height:12px;vertical-align:middle"></p>
      <p style="color:#777;font-size:13px;">2% от трат рефералов</p>
      <button onclick="withdrawRef()">Вывести</button>
    </div>

    <div class="profile-tabs">
      <button class="active" onclick="switchProfileTab('purchases')">Мои покупки</button>
      <button onclick="switchProfileTab('myitems')">Мои товары</button>
    </div>

    <div id="purchases" class="profile-section active">
      <div class="profile-search"><input id="purchases-search" placeholder="Поиск покупок..." oninput="render()"></div>
      <div id="purchases-grid" class="grid"></div>
      <p id="purchases-empty" style="text-align:center;color:#777;">Пусто</p>
    </div>

    <div id="myitems" class="profile-section">
      <div class="profile-search"><input id="myitems-search" placeholder="Поиск товаров..." oninput="render()"></div>
      <div id="myitems-grid" class="grid"></div>
      <p id="myitems-empty" style="text-align:center;color:#777;">Пусто</p>
    </div>
  </section>
</main>

<div class="tabs">
  <button class="active" onclick="switchTab('home',this)">Главная</button>
  <button onclick="switchTab('add',this)">Добавить</button>
  <button onclick="switchTab('profile',this)">Профиль</button>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modal-name"></h3>
    <img id="modal-img">
    <p id="modal-desc"></p>
    <p><b>Цена:</b> <span id="modal-price"></span> <img src="ton1.svg" class="icon"></p>
    <div id="modal-actions"></div>
    <div id="modal-rating"></div>
    <button onclick="closeModal()">Закрыть</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let balance=1000, refBalance=0, userId=1;
let purchases=[], myItems=[], ratedItems=[];
let sort="newest";
const tonIcon='<img src="ton1.svg" style="width:12px;height:12px;vertical-align:middle;">';

let items=[
  {id:101,name:"Скрипт Telegram Bot",desc:"Полностью рабочий бот",price:15,img:"https://via.placeholder.com/300x200?text=Bot",file:"bot.zip",ownerId:2,reviews:[5,4]},
  {id:102,name:"Видеоурок по дизайну",desc:"Советы для UI/UX",price:8,img:"https://via.placeholder.com/300x200?text=Design",file:"design.mp4",ownerId:3,reviews:[5,5,4]},
  {id:103,name:"NFT шаблон",desc:"Шаблон NFT-коллекции",price:22,img:"https://via.placeholder.com/300x200?text=NFT",file:"nft.psd",ownerId:4,reviews:[4,3]},
  {id:104,name:"React сайт",desc:"Красивый адаптивный шаблон",price:18,img:"https://via.placeholder.com/300x200?text=React",file:"site.zip",ownerId:5,reviews:[]},
  {id:105,name:"Python API пример",desc:"REST API шаблон",price:12,img:"https://via.placeholder.com/300x200?text=API",file:"api.py",ownerId:6,reviews:[5]}
];

function switchTab(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

function switchProfileTab(id){
  document.querySelectorAll('.profile-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.profile-tabs button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  render();
}

function publish(){
  let name=document.getElementById('add-name').value.trim();
  let desc=document.getElementById('add-desc').value.trim();
  let price=parseFloat(document.getElementById('add-price').value)||0;
  let imgFile=document.getElementById('add-preview').files[0];
  let file=document.getElementById('add-file').files[0];
  if(!name||!desc||!price||!imgFile||!file){showToast("Заполните все поля");return;}
  let reader=new FileReader();
  reader.onload=e=>{
    let id=Math.floor(Math.random()*999999)+1;
    let item={id,name,desc,price,img:e.target.result,file:file.name,ownerId:userId,reviews:[]};
    items.unshift(item);myItems.push(item);
    document.getElementById('add-name').value="";
    document.getElementById('add-desc').value="";
    document.getElementById('add-price').value="";
    document.getElementById('add-preview').value="";
    document.getElementById('add-file').value="";
    showToast("Товар опубликован");
    render();
  };
  reader.readAsDataURL(imgFile);
}

function openModal(item){
  document.getElementById('modal-name').innerText=item.name;
  document.getElementById('modal-img').src=item.img;
  document.getElementById('modal-desc').innerText=item.desc;
  document.getElementById('modal-price').innerText=item.price.toFixed(2);
  let act=document.getElementById('modal-actions');
  act.innerHTML="";
  if(item.ownerId===userId){
    act.innerHTML="<button>Мой товар</button>";
  } else if(purchases.includes(item.id)){
    act.innerHTML=`<button>Приобретено</button><button>Получить файл</button>`;
  } else {
    act.innerHTML=`<button onclick='buy(${item.id})'>Купить за ${item.price}${tonIcon}</button>`;
  }
  let rating=document.getElementById('modal-rating');
  let avg=calcAvg(item.reviews);
  rating.innerHTML=`Рейтинг: ${avg.toFixed(1)} ⭐ (${item.reviews.length})`;
  if(purchases.includes(item.id) && !ratedItems.includes(item.id)){
    let stars=document.createElement("div");
    stars.className="stars";
    for(let i=1;i<=5;i++){
      let s=document.createElement("span");
      s.innerText="★";s.className="star";
      s.onclick=()=>rateItem(item.id,i);
      stars.appendChild(s);
    }
    rating.appendChild(stars);
  }
  document.getElementById('modal').classList.add('active');
}

function closeModal(){document.getElementById('modal').classList.remove('active');}
function buy(id){
  let item=items.find(i=>i.id===id);
  if(balance<item.price){showToast("Недостаточно средств");return;}
  balance-=item.price;refBalance+=item.price*0.02;purchases.push(id);
  showToast("Покупка успешна");
  render();closeModal();
}
function rateItem(id,val){
  let item=items.find(i=>i.id===id);
  item.reviews.push(val);ratedItems.push(id);
  showToast("Спасибо за отзыв!");
  render();closeModal();
}
function withdrawRef(){
  if(refBalance<=0){showToast("Нет средств");return;}
  balance+=refBalance;refBalance=0;showToast("Вывод успешен");render();
}
function calcAvg(a){return a.length?a.reduce((x,y)=>x+y)/a.length:0;}
function showToast(m){
  let t=document.getElementById('toast');
  t.innerText=m;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function render(){
  document.getElementById('balance').innerText=balance.toFixed(2);
  document.getElementById('ref-balance').innerText=refBalance.toFixed(2);
  let search=document.getElementById('search-input').value.toLowerCase();
  let min=parseFloat(document.getElementById('min-price').value)||0;
  let max=parseFloat(document.getElementById('max-price').value)||Infinity;

  let list=items.filter(i=>(i.name+i.desc).toLowerCase().includes(search))
                .filter(i=>i.price>=min&&i.price<=max);

  if(sort==="price_asc")list.sort((a,b)=>a.price-b.price);
  else if(sort==="price_desc")list.sort((a,b)=>b.price-a.price);
  else if(sort==="best")list.sort((a,b)=>calcAvg(b.reviews)-calcAvg(a.reviews));
  else if(sort==="count")list.sort((a,b)=>b.reviews.length-a.reviews.length);
  else list.sort((a,b)=>b.id-a.id);

  let grid=document.getElementById('market-grid');
  grid.innerHTML=list.map(i=>`
    <div class='card'>
      <div class='item-id'>#${String(i.id).padStart(5,'0')}</div>
      <img src='${i.img}'>
      <div class='card-content'>
        <h3>${i.name}</h3>
        <p>${i.desc}</p>
        <div class='info-line'>
          <span>⭐ ${calcAvg(i.reviews).toFixed(1)} (${i.reviews.length})</span>
          <span>${i.price}${tonIcon}</span>
        </div>
        ${purchases.includes(i.id)
          ?"<div style='display:flex;gap:4px;'><button>Приобретено</button><button>Получить файл</button></div>"
          :`<button onclick='openModal(${i.id})'>Подробнее</button>`}
      </div>
    </div>`).join("");

  // Profile rendering
  let pGrid=document.getElementById('purchases-grid');
  let mGrid=document.getElementById('myitems-grid');
  let pSearch=document.getElementById('purchases-search').value.toLowerCase();
  let mSearch=document.getElementById('myitems-search').value.toLowerCase();
  let pItems=items.filter(i=>purchases.includes(i.id)&& (i.name+i.desc).toLowerCase().includes(pSearch));
  let mItems=items.filter(i=>i.ownerId===userId && (i.name+i.desc).toLowerCase().includes(mSearch));

  pGrid.innerHTML=pItems.map(i=>`
    <div class='card'>
      <div class='item-id'>#${String(i.id).padStart(5,'0')}</div>
      <img src='${i.img}'>
      <div class='card-content'>
        <h3>${i.name}</h3>
        <p>${i.desc}</p>
        <div class='info-line'>
          <span>⭐ ${calcAvg(i.reviews).toFixed(1)} (${i.reviews.length})</span>
          <span>${i.price}${tonIcon}</span>
        </div>
        <div style='display:flex;gap:4px;'>
          <button>Приобретено</button><button>Получить файл</button>
        </div>
      </div>
    </div>`).join("");

  mGrid.innerHTML=mItems.map(i=>`
    <div class='card'>
      <div class='item-id'>#${String(i.id).padStart(5,'0')}</div>
      <img src='${i.img}'>
      <div class='card-content'>
        <h3>${i.name}</h3>
        <p>${i.desc}</p>
        <div class='info-line'>
          <span>⭐ ${calcAvg(i.reviews).toFixed(1)} (${i.reviews.length})</span>
          <span>${i.price}${tonIcon}</span>
        </div>
        <button>Мой товар</button>
      </div>
    </div>`).join("");

  document.getElementById('purchases-empty').style.display=pItems.length?"none":"block";
  document.getElementById('myitems-empty').style.display=mItems.length?"none":"block";
}

// Custom select
document.querySelector('#sort-btn').onclick=()=>document.querySelector('#sort-select').classList.toggle('open');
document.querySelectorAll('#sort-select .custom-options div').forEach(o=>{
  o.onclick=()=>{
    sort=o.dataset.val;
    document.getElementById('sort-btn').innerText=o.innerText;
    document.querySelector('#sort-select').classList.remove('open');
    render();
  };
});
render();
</script>
</body>
</html>
